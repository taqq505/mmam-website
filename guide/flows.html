<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MMAM HOW TO USE - flow-hub">
    <title>MMAM Guide / flow-hub</title>
    <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-900 font-sans" data-guide-page="flow-hub">
    <div class="lg:flex">

<aside id="guide-sidebar" class="bg-slate-900 text-white w-72 min-h-screen flex flex-col fixed inset-y-0 left-0 z-40 transform transition-transform duration-200 lg:translate-x-0 -translate-x-full">
    <div class="px-6 py-5 border-b border-white/10 flex items-center gap-3">
        <svg width="40" height="40" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
            <rect x="4" y="4" width="56" height="56" rx="14" fill="#1e293b"/>
            <g fill="none" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="32" cy="28" r="8" stroke="#60a5fa" stroke-width="3"/>
                <path d="M20 44 A16 16 0 0 1 44 44" stroke="#3b82f6" stroke-width="3"/>
                <circle cx="20" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
                <circle cx="32" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
                <circle cx="44" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
            </g>
        </svg>
        <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-300">HOW TO USE</p>
            <h1 class="text-xl font-semibold">MMAM Guide</h1>
        </div>
    </div>
    <nav class="flex-1 px-4 py-6 overflow-y-auto text-sm space-y-1">
        <a href="index.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="overview">概要</a>
        <a href="stack.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="stack">スタック構成</a>
        <a href="flows.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="flow-hub">フローとテキストハブ</a>
        <a href="planner.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="planner">Planner / Address Map</a>
        <a href="nmos.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="nmos">NMOS連携</a>
        <a href="checker.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="checker">Checker & 自動化</a>
        <a href="api.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="api">REST API / MQTT</a>
        <a href="setup.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="setup">セットアップ</a>
    </nav>
    <div class="px-4 py-4 border-t border-white/10 space-y-3 text-xs">
        <a href="../index.html" class="block bg-white/10 rounded px-3 py-2 text-center">トップページへ</a>
    </div>
</aside>

        <div class="flex-1 lg:ml-72 min-h-screen bg-slate-50">
            <header class="sticky top-0 z-30 bg-slate-50/95 backdrop-blur border-b border-slate-200 flex items-center justify-between px-4 py-3 lg:hidden">
                <button id="guide-sidebar-toggle" class="px-3 py-2 rounded border border-slate-300 text-sm font-medium">メニュー</button>
                <a href="../index.html" class="text-sm text-slate-500 underline">トップページ</a>
            </header>
            <main class="px-6 py-10 max-w-5xl mx-auto space-y-12">

<section class="bg-gradient-to-r from-emerald-900 via-slate-900 to-emerald-800 rounded-3xl text-white p-8 shadow-xl border border-emerald-900 space-y-4">
    <div>
        <p class="text-xs uppercase tracking-[0.6em] text-white/60">flows</p>
        <h2 class="text-3xl font-semibold">フロー管理とテキストハブの活用</h2>
        <p class="text-white/80">実際の運用で必要な「フロー検索→情報更新」の流れを、API操作例とともに詳しく解説します。</p>
    </div>
    <div class="flex flex-wrap gap-3">
        <a href="../index.html" class="px-4 py-2 rounded-full bg-white text-slate-900 font-semibold text-sm shadow">トップページへ</a>
        <a href="https://github.com/taqq505/mmam-docker/blob/main/src/app/routers/flows.py" target="_blank" class="px-4 py-2 rounded-full border border-white/30 text-sm">flows API コード</a>
    </div>
</section>

<section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-6">
    <h3 class="text-2xl font-semibold">実践シナリオ: マルチキャストアドレスからフロー情報を更新</h3>
    <p class="text-slate-700 leading-relaxed">
        障害対応中に「Source IP: 192.168.10.101、Multicast IP: 239.100.1.10 のフローの担当者を変更したい」という状況を考えます。
        この流れを3ステップで実行します。
    </p>

    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 space-y-4">
        <h4 class="font-semibold text-lg">ステップ1: Source IP と Multicast IP でフローを検索</h4>
        <p class="text-sm text-slate-600">まず、該当するフローの <code>flow_id</code> を取得します。</p>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code># Source IPとMulticast IPでフローを検索
curl -H "Authorization: Bearer YOUR_TOKEN" \
  'https://localhost:8443/api/flows?source_addr_a=192.168.10.101&multicast_addr_a=239.100.1.10'</code></pre>
        <p class="text-xs text-slate-500 mt-2">→ レスポンス例:</p>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code>[
  {
    "flow_id": "f1a2b3c4-d5e6-47a8-b9c0-d1e2f3a4b5c6",
    "display_name": "STUDIO-A CAM-01 Video",
    "source_addr_a": "192.168.10.101",
    "multicast_addr_a": "239.100.1.10",
    "group_port_a": 5000,
    "alias1": "Studio A Main Camera",
    "alias2": "CAM-01-4K",
    "user_field7": "Operator: John Smith",
    ...
  }
]</code></pre>
        <p class="text-xs text-slate-500">→ <code>flow_id</code> が <code>f1a2b3c4-d5e6-47a8-b9c0-d1e2f3a4b5c6</code> と分かりました。</p>
    </div>

    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 space-y-4">
        <h4 class="font-semibold text-lg">ステップ2: Alias情報を更新（PATCH）</h4>
        <p class="text-sm text-slate-600">取得した <code>flow_id</code> を使って、テキストハブの情報を更新します。</p>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code># Alias と User Field を更新
curl -X PATCH https://localhost:8443/api/flows/f1a2b3c4-d5e6-47a8-b9c0-d1e2f3a4b5c6 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "alias1": "Studio A Main Camera (Updated)",
    "alias2": "CAM-01-4K-NEW",
    "user_field7": "Operator: Sarah Martinez (2025-01-20)",
    "user_field8": "Emergency contact: ext.1234"
  }'</code></pre>
        <p class="text-xs text-slate-500 mt-2">→ レスポンスで更新後のフロー情報全体が返ってきます。</p>
    </div>

    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 space-y-4">
        <h4 class="font-semibold text-lg">ステップ3: 更新内容を確認</h4>
        <p class="text-sm text-slate-600">念のため、再度GETして更新が反映されているか確認します。</p>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code># フローIDで取得
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://localhost:8443/api/flows/f1a2b3c4-d5e6-47a8-b9c0-d1e2f3a4b5c6</code></pre>
        <p class="text-xs text-slate-500 mt-2">→ <code>user_field7</code> と <code>user_field8</code> が更新されていることを確認できます。</p>
        <p class="text-xs text-slate-500">→ MQTT購読者にも更新通知が送信されます（MQTTが有効な場合）。</p>
    </div>
</section>

<section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-6">
    <h3 class="text-2xl font-semibold">UIでの操作フロー</h3>
    <ol class="list-decimal ml-5 text-slate-700 space-y-3">
        <li>
            <strong>Quick Search でフィルタ</strong><br>
            <span class="text-sm text-slate-600">左メニュー「Flows」を開き、上部の Quick Search に <code>239.100.1.10</code> を入力。該当するフローが即座に絞り込まれます。</span>
        </li>
        <li>
            <strong>フロー詳細を開く</strong><br>
            <span class="text-sm text-slate-600">リストから該当フローをクリック。右パネルにS/G/Port、冗長系、Alias、User Field、NMOS情報が表示されます。</span>
        </li>
        <li>
            <strong>Alias / User Field を編集</strong><br>
            <span class="text-sm text-slate-600">「Edit」ボタンをクリックし、<code>alias1</code> や <code>user_field7</code> を直接編集。保存前にバリデーション結果がリアルタイム表示されます。</span>
        </li>
        <li>
            <strong>Lock機能で排他制御</strong><br>
            <span class="text-sm text-slate-600">重要なフローは「Lock Flow」を有効にし、他のユーザーが誤って上書きしないよう保護できます。ロック中は HTTP 423 が返ります。</span>
        </li>
    </ol>
</section>

<section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-6">
    <h3 class="text-2xl font-semibold">テキストハブの設計例</h3>
    <p class="text-slate-700">Alias と User Field の使い分けを明確にすると、運用が整理されます。</p>
    <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="border border-slate-200 rounded-xl p-4 space-y-2">
            <h4 class="font-semibold text-sm text-slate-800">Alias 1〜8（固定情報）</h4>
            <ul class="list-disc ml-5 text-xs text-slate-600 space-y-1">
                <li><code>alias1</code>: 正式名称</li>
                <li><code>alias2</code>: 略称コード</li>
                <li><code>alias3</code>: 機器メーカー・型番</li>
                <li><code>alias4〜8</code>: 施設コード、用途タグ</li>
            </ul>
        </div>
        <div class="border border-slate-200 rounded-xl p-4 space-y-2">
            <h4 class="font-semibold text-sm text-slate-800">User Field 1〜8（可変情報）</h4>
            <ul class="list-disc ml-5 text-xs text-slate-600 space-y-1">
                <li><code>user_field1</code>: 監視担当者</li>
                <li><code>user_field2</code>: 連絡先・内線番号</li>
                <li><code>user_field3</code>: メンテナンス予定日</li>
                <li><code>user_field4〜8</code>: Slack/TeamsのスレッドID</li>
            </ul>
        </div>
    </div>
    <p class="text-xs text-slate-500 mt-3">→ この区分をPlanner のノート欄や Confluence に文書化しておくと、チーム全体で迷わず運用できます。</p>
</section>

<section class="grid md:grid-cols-2 gap-6">
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-3">
        <h3 class="text-xl font-semibold">検索パラメータ一覧</h3>
        <p class="text-sm text-slate-600">GET <code>/api/flows</code> で使える主なクエリパラメータ:</p>
        <ul class="list-disc ml-5 text-xs text-slate-600 space-y-1">
            <li><code>display_name</code>: 表示名で部分一致検索</li>
            <li><code>multicast_addr_a</code>: マルチキャストIP（パスA）</li>
            <li><code>source_addr_a</code>: ソースIP（パスA）</li>
            <li><code>flow_status</code>: active / inactive / standby</li>
            <li><code>media_type</code>: video / audio / ancillary</li>
            <li><code>limit</code> / <code>offset</code>: ページング</li>
        </ul>
    </article>
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-3">
        <h3 class="text-xl font-semibold">API操作の注意点</h3>
        <ul class="list-disc ml-5 text-sm text-slate-600 space-y-1">
            <li>PATCH では変更したいフィールドだけ送信（全フィールド不要）</li>
            <li>ロック中のフローを更新すると HTTP 423 が返る</li>
            <li>MQTT有効時は更新がリアルタイムでブロードキャスト</li>
            <li>Checker連携時は衝突検出が自動実行</li>
        </ul>
    </article>
</section>
            </main>
        </div>
    </div>
    <script src="../js/guide.js"></script>
</body>
</html>
