<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MMAM HOW TO USE - api">
    <title>MMAM Guide / api</title>
    <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-900 font-sans" data-guide-page="api">
    <div class="lg:flex">

<aside id="guide-sidebar" class="bg-slate-900 text-white w-72 min-h-screen flex flex-col fixed inset-y-0 left-0 z-40 transform transition-transform duration-200 lg:translate-x-0 -translate-x-full">
    <div class="px-6 py-5 border-b border-white/10 flex items-center gap-3">
        <svg width="40" height="40" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
            <rect x="4" y="4" width="56" height="56" rx="14" fill="#1e293b"/>
            <g fill="none" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="32" cy="28" r="8" stroke="#60a5fa" stroke-width="3"/>
                <path d="M20 44 A16 16 0 0 1 44 44" stroke="#3b82f6" stroke-width="3"/>
                <circle cx="20" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
                <circle cx="32" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
                <circle cx="44" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
            </g>
        </svg>
        <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-300">HOW TO USE</p>
            <h1 class="text-xl font-semibold">MMAM Guide</h1>
        </div>
    </div>
    <nav class="flex-1 px-4 py-6 overflow-y-auto text-sm space-y-1">
        <a href="index.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="overview">概要</a>
        <a href="stack.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="stack">スタック構成</a>
        <a href="setup.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="setup">セットアップ＆コンフィグレーション</a>
        <a href="dashboard.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="dashboard">Dashboard / ダッシュボード</a>
        <a href="flows.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="flows">Flows / フロー一覧</a>
        <a href="search.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="search">Search / 検索</a>
        <a href="new-flow.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="new-flow">New Flow / 新規フロー</a>
        <a href="nmos.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="nmos">NMOS Wizard / インポート</a>
        <a href="planner.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="planner">Planner / プランナー</a>
        <a href="checker.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="checker">Checker / チェック</a>
        <a href="users.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="users">Users / ユーザー管理</a>
        <a href="settings.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="settings">Settings / 設定</a>
        <a href="usecases.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="usecases">ユースケース</a>
        <a href="api.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="api">REST APIまとめ</a>
    </nav>
    <div class="px-4 py-4 border-t border-white/10 space-y-3 text-xs">
        <a href="../index.html" class="block bg-white/10 rounded px-3 py-2 text-center">トップページへ</a>
    </div>
</aside>

        <div class="flex-1 lg:ml-72 min-h-screen bg-slate-50">
            <header class="sticky top-0 z-30 bg-slate-50/95 backdrop-blur border-b border-slate-200 flex items-center justify-between px-4 py-3 lg:hidden">
                <button id="guide-sidebar-toggle" class="px-3 py-2 rounded border border-slate-300 text-sm font-medium">メニュー</button>
                <a href="../index.html" class="text-sm text-slate-500 underline">トップページ</a>
            </header>
            <main class="px-6 py-10 max-w-5xl mx-auto space-y-12">

<section class="bg-gradient-to-r from-slate-900 via-blue-900 to-slate-800 rounded-3xl text-white p-8 shadow-xl border border-blue-900 space-y-4">
    <div>
        <p class="text-xs uppercase tracking-[0.6em] text-white/60">api</p>
        <h2 class="text-3xl font-semibold">REST API / MQTT リファレンス</h2>
        <p class="text-white/80">JWT認証の流れから PATCH 実装、MQTT 購読例まで、初めての方にも分かりやすくまとめました。実際の運用で役立つエラーハンドリングの方法も解説します。</p>
    </div>
    <div class="flex flex-wrap gap-3">
        <a href="../index.html" class="px-4 py-2 rounded-full bg-white text-slate-900 font-semibold text-sm shadow">トップページへ</a>
        <a href="https://github.com/taqq505/mmam-docker/tree/main/src/app/routers" target="_blank" class="px-4 py-2 rounded-full border border-white/30 text-sm">APIソース</a>
    </div>
</section>

<section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-6">
    <h3 class="text-2xl font-semibold">認証と基本リクエスト</h3>
    <ol class="list-decimal ml-5 text-slate-700 space-y-2">
        <li><code>POST /api/login</code> にユーザー名/パスワードを送信し、JWTを取得。</li>
        <li>以降のRESTリクエストでは <code>Authorization: Bearer &lt;token&gt;</code> を付与。</li>
        <li>トークンは1時間有効。自動スクリプトは期限切れ前にリフレッシュするか再ログイン。</li>
    </ol>
    <pre class="bg-slate-900 text-white text-xs rounded-2xl p-4 overflow-x-auto"><code>curl -X POST https://localhost:8443/api/login \\
  -H \"Content-Type: application/x-www-form-urlencoded\" \\
  -d 'username=admin&password=admin'</code></pre>
</section>

<section class="grid md:grid-cols-2 gap-6">
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-3">
        <h3 class="text-xl font-semibold">主要RESTエンドポイント</h3>
        <ul class="list-disc ml-5 text-slate-600 space-y-1">
            <li><code>GET /api/flows</code>, <code>POST /api/flows</code>, <code>PATCH /api/flows/{id}</code></li>
            <li><code>GET /api/address/buckets/overview</code>, <code>POST /api/address/buckets/child</code></li>
            <li><code>GET /api/checker/latest</code>, <code>POST /api/automation/jobs/{id}/enable</code></li>
            <li><code>GET /api/logs?kind=api|audit</code></li>
        </ul>
    </article>
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-3">
        <h3 class="text-xl font-semibold">MQTTトピック</h3>
        <ul class="list-disc ml-5 text-slate-600 space-y-1">
            <li><code>mmam/flows/events</code> — Flow作成/更新/削除（<code>/all</code> と <code>/flow/{id}</code> にブロードキャスト）。</li>
        </ul>
        <pre class="bg-slate-900 text-white text-xs rounded-2xl p-4 overflow-x-auto"><code>// MQTT.js例
client.subscribe('mmam/flows/events');
client.on('message', (_, payload) =&gt; {
  const event = JSON.parse(payload.toString());
  console.log(event.flow_id, event.event);
});</code></pre>
    </article>
</section>

<section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-6">
    <h3 class="text-2xl font-semibold">実践シナリオ: 認証からフロー更新まで</h3>
    <p class="text-slate-700 leading-relaxed">
        外部スクリプトから MMAM API を呼び出して、フロー情報を更新する一連の流れを実装します。
        このシナリオでは、Python を使って「認証 → 検索 → 更新 → 確認」の4ステップを実行します。
    </p>

    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 space-y-4">
        <h4 class="font-semibold text-lg">ステップ1: JWT トークンを取得</h4>
        <p class="text-sm text-slate-600">まず、ログインして認証トークンを取得します。</p>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code>import requests

API_BASE = "https://localhost:8443"

# ログインしてトークン取得
response = requests.post(
    f"{API_BASE}/login",
    json={"username": "admin", "password": "admin"},
    verify=False  # 自己署名証明書の場合
)
token = response.json()["access_token"]
headers = {"Authorization": f"Bearer {token}"}</code></pre>
    </div>

    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 space-y-4">
        <h4 class="font-semibold text-lg">ステップ2: 条件でフローを検索</h4>
        <p class="text-sm text-slate-600">Source IP と Multicast IP を指定してフローを検索します。</p>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code># フロー検索
params = {
    "source_addr_a": "192.168.10.101",
    "multicast_addr_a": "239.100.1.10"
}
response = requests.get(
    f"{API_BASE}/api/flows",
    headers=headers,
    params=params,
    verify=False
)
flows = response.json()
if not flows:
    print("フローが見つかりません")
    exit(1)

flow_id = flows[0]["flow_id"]
print(f"対象フロー: {flow_id}")</code></pre>
    </div>

    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 space-y-4">
        <h4 class="font-semibold text-lg">ステップ3: PATCH で部分更新</h4>
        <p class="text-sm text-slate-600">取得した flow_id を使って、必要なフィールドだけを更新します。</p>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code># フロー情報を部分更新
update_data = {
    "alias1": "Studio A Main Camera (Updated)",
    "user_field7": "Operator: Sarah Martinez",
    "user_field8": "Emergency: ext.1234"
}
response = requests.patch(
    f"{API_BASE}/api/flows/{flow_id}",
    headers=headers,
    json=update_data,
    verify=False
)

if response.status_code == 200:
    print("更新成功")
elif response.status_code == 423:
    print("エラー: フローがロックされています")
else:
    print(f"エラー: {response.status_code} - {response.text}")</code></pre>
    </div>

    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 space-y-4">
        <h4 class="font-semibold text-lg">ステップ4: 更新内容を確認</h4>
        <p class="text-sm text-slate-600">最後に GET で取得し、更新が反映されているか確認します。</p>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code># 更新後のフロー情報を取得
response = requests.get(
    f"{API_BASE}/api/flows/{flow_id}",
    headers=headers,
    verify=False
)
flow = response.json()
print(f"alias1: {flow['alias1']}")
print(f"user_field7: {flow['user_field7']}")
print(f"user_field8: {flow['user_field8']}")</code></pre>
    </div>
</section>

<section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-6">
    <h3 class="text-2xl font-semibold">MQTT リアルタイム購読の実装例</h3>
    <p class="text-slate-700 leading-relaxed">
        MQTT を使うと、フローの作成・更新・削除がリアルタイムで通知されます。
        外部の監視システムや通知システムと連携する際に便利です。
    </p>

    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 space-y-4">
        <h4 class="font-semibold text-lg">Node.js での MQTT 購読例</h4>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code>const mqtt = require('mqtt');

// MQTT ブローカーに接続
const client = mqtt.connect('mqtt://localhost:1883', {
  username: 'mmam',
  password: 'your-mqtt-password'
});

client.on('connect', () => {
  console.log('MQTT接続成功');

  // フローイベントを購読（作成/更新/削除）
  client.subscribe('mmam/flows/events', (err) => {
    if (!err) console.log('購読開始: mmam/flows/events');
  });
});

client.on('message', (topic, payload) => {
  const event = JSON.parse(payload.toString());

  if (topic === 'mmam/flows/events') {
    console.log(`フローイベント: ${event.event}`);
    console.log(`  flow_id: ${event.flow_id}`);
    console.log(`  display_name: ${event.flow?.display_name}`);

    // Slackへ通知する例
    if (event.event === 'created') {
      notifySlack(`新しいフローが作成されました: ${event.flow?.display_name}`);
    }
  }
});</code></pre>
    </div>

    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 space-y-4">
        <h4 class="font-semibold text-lg">Python での MQTT 購読例</h4>
        <pre class="bg-slate-900 text-white text-xs rounded-xl p-4 overflow-x-auto"><code>import paho.mqtt.client as mqtt
import json

def on_connect(client, userdata, flags, rc):
    print(f"MQTT接続: {rc}")
    client.subscribe("mmam/flows/events")

def on_message(client, userdata, msg):
    event = json.loads(msg.payload.decode())

    if msg.topic == "mmam/flows/events":
        print(f"フローイベント: {event['event']}")
        print(f"  flow_id: {event['flow_id']}")
        # データベースに記録する例
        log_to_database(event)

client = mqtt.Client()
client.username_pw_set("mmam", "your-mqtt-password")
client.on_connect = on_connect
client.on_message = on_message
client.connect("localhost", 1883, 60)
client.loop_forever()</code></pre>
    </div>
</section>

<section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-6">
    <h3 class="text-2xl font-semibold">エラーハンドリングとベストプラクティス</h3>
    <div class="grid md:grid-cols-2 gap-4">
        <div class="border border-slate-200 rounded-xl p-4 space-y-2">
            <h4 class="font-semibold text-sm text-slate-800">よくあるエラーコード</h4>
            <ul class="list-disc ml-5 text-xs text-slate-600 space-y-1">
                <li><code>401 Unauthorized</code>: トークン期限切れ → 再ログイン</li>
                <li><code>404 Not Found</code>: flow_id が存在しない</li>
                <li><code>423 Locked</code>: フローがロック中 → 解除を待つ</li>
                <li><code>422 Unprocessable Entity</code>: バリデーションエラー</li>
            </ul>
        </div>
    </div>
</section>

<section class="grid md:grid-cols-2 gap-6">
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-3">
        <h3 class="text-xl font-semibold">主要RESTエンドポイント</h3>
        <ul class="list-disc ml-5 text-sm text-slate-600 space-y-1">
            <li><code>POST /login</code> — JWT認証</li>
            <li><code>GET /api/flows</code> — フロー検索</li>
            <li><code>POST /api/flows</code> — フロー作成</li>
            <li><code>PATCH /api/flows/{id}</code> — フロー更新</li>
            <li><code>DELETE /api/flows/{id}</code> — フロー削除</li>
            <li><code>GET /api/address/buckets/overview</code> — アドレスマップ取得</li>
            <li><code>POST /api/address/buckets/child</code> — 子バケット作成</li>
            <li><code>GET /api/checker/latest</code> — 最新の検証結果</li>
            <li><code>GET /api/logs</code> — ログ取得</li>
        </ul>
    </article>
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-3">
        <h3 class="text-xl font-semibold">システム連携のヒント</h3>
        <ul class="list-disc ml-5 text-sm text-slate-600 space-y-1">
            <li>外部システムのキーと <code>flow_id</code> を紐付けて管理</li>
            <li>MQTT イベントを Webhook へ転送して Issue Tracker と連携</li>
            <li><code>GET /api/flows/export</code> で全データを取得し Git で管理</li>
            <li>Checker の自動実行結果をメール/Slack に通知</li>
            <li>CI/CD で <code>POST /api/flows/import</code> を使って環境同期</li>
        </ul>
    </article>
</section>
            </main>
        </div>
    </div>
    <script src="../js/guide.js"></script>
</body>
</html>
