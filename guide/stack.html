<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MMAM HOW TO USE - stack">
    <title>MMAM Guide / stack</title>
    <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-900 font-sans" data-guide-page="stack">
    <div class="lg:flex">

<aside id="guide-sidebar" class="bg-slate-900 text-white w-72 min-h-screen flex flex-col fixed inset-y-0 left-0 z-40 transform transition-transform duration-200 lg:translate-x-0 -translate-x-full">
    <div class="px-6 py-5 border-b border-white/10 flex items-center gap-3">
        <svg width="40" height="40" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
            <rect x="4" y="4" width="56" height="56" rx="14" fill="#1e293b"/>
            <g fill="none" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="32" cy="28" r="8" stroke="#60a5fa" stroke-width="3"/>
                <path d="M20 44 A16 16 0 0 1 44 44" stroke="#3b82f6" stroke-width="3"/>
                <circle cx="20" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
                <circle cx="32" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
                <circle cx="44" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
            </g>
        </svg>
        <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-300">HOW TO USE</p>
            <h1 class="text-xl font-semibold">MMAM Guide</h1>
        </div>
    </div>
    <nav class="flex-1 px-4 py-6 overflow-y-auto text-sm space-y-1">
        <a href="index.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="overview">概要</a>
        <a href="stack.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="stack">スタック構成</a>
        <a href="setup.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="setup">セットアップ＆コンフィグレーション</a>
        <a href="dashboard.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="dashboard">Dashboard / ダッシュボード</a>
        <a href="flows.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="flows">Flows / フロー一覧</a>
        <a href="search.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="search">Search / 検索</a>
        <a href="new-flow.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="new-flow">New Flow / 新規フロー</a>
        <a href="nmos.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="nmos">NMOS Wizard / インポート</a>
        <a href="planner.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="planner">Planner / プランナー</a>
        <a href="checker.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="checker">Checker / チェック</a>
        <a href="users.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="users">Users / ユーザー管理</a>
        <a href="settings.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="settings">Settings / 設定</a>
        <a href="usecases.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="usecases">ユースケース</a>
        <a href="api.html" class="guide-link block px-3 py-2 rounded hover:bg-white/10 transition" data-guide-link="api">REST APIまとめ</a>
    </nav>
    <div class="px-4 py-4 border-t border-white/10 space-y-3 text-xs">
        <a href="../index.html" class="block bg-white/10 rounded px-3 py-2 text-center">トップページへ</a>
    </div>
</aside>

        <div class="flex-1 lg:ml-72 min-h-screen bg-slate-50">
            <header class="sticky top-0 z-30 bg-slate-50/95 backdrop-blur border-b border-slate-200 flex items-center justify-between px-4 py-3 lg:hidden">
                <button id="guide-sidebar-toggle" class="px-3 py-2 rounded border border-slate-300 text-sm font-medium">メニュー</button>
                <a href="../index.html" class="text-sm text-slate-500 underline">トップページ</a>
            </header>
            <main class="px-6 py-10 max-w-5xl mx-auto space-y-12">

<section class="bg-gradient-to-r from-indigo-900 via-slate-900 to-slate-800 rounded-3xl text-white p-8 shadow-xl border border-slate-800 space-y-4">
    <div>
        <p class="text-xs uppercase tracking-[0.6em] text-white/60">stack</p>
        <h2 class="text-3xl font-semibold">MMAM のスタック構成</h2>
        <p class="text-white/80">Docker Compose が起動する各サービスの役割や接続経路、設定ファイルを把握できるようにまとめています。トラブル時の調査にも役立つ情報を含めています。</p>
    </div>
    <div class="flex flex-wrap gap-3">
        <a href="../index.html" class="px-4 py-2 rounded-full bg-white text-slate-900 font-semibold text-sm shadow">トップページへ</a>
        <a href="https://github.com/taqq505/mmam-docker/blob/main/docker-compose.yml" target="_blank" class="px-4 py-2 rounded-full border border-white/30 text-sm">compose.yml を開く</a>
    </div>
</section>

<section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-6">
    <header>
        <h3 class="text-2xl font-semibold">サービス一覧と代表ポート</h3>
        <p class="text-slate-600 mt-2">MMAM は 4 つのコンテナで構成されています。各サービスの役割と設定場所を以下の表にまとめています。</p>
    </header>
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead>
            <tr class="text-left text-slate-500 uppercase tracking-wide text-xs border-b border-slate-200">
                <th class="py-2 pr-4">サービス</th>
                <th class="py-2 pr-4">役割と保存先</th>
                <th class="py-2 pr-4">ポート / 備考</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
            <tr>
                <td class="py-3 pr-4 font-medium text-slate-800">mmam</td>
                <td class="py-3 pr-4 text-slate-600">FastAPI サービスです。REST エンドポイントや Scheduler、NMOS ツールを集約します。</td>
                <td class="py-3 pr-4 text-slate-600">8080 (HTTP) / 8443 (HTTPS) を待ち受けます。TLS 証明書は <code>certs/</code> に保存します。</td>
            </tr>
            <tr>
                <td class="py-3 pr-4 font-medium text-slate-800">ui</td>
                <td class="py-3 pr-4 text-slate-600">Vue 3 UI を nginx で配信します。<code>frontend/dist</code> を読み込みます。</td>
                <td class="py-3 pr-4 text-slate-600">4173 / 4174 を使用し、UI が API URL を自動判別します。</td>
            </tr>
            <tr>
                <td class="py-3 pr-4 font-medium text-slate-800">db</td>
                <td class="py-3 pr-4 text-slate-600">PostgreSQL 16 です。flows や planner_buckets、scheduled_jobs（自動化設定）などを保存します。</td>
                <td class="py-3 pr-4 text-slate-600">5432 (内部) を利用します。永続化は <code>./pgdata</code> に行います。</td>
            </tr>
            <tr>
                <td class="py-3 pr-4 font-medium text-slate-800">mqtt</td>
                <td class="py-3 pr-4 text-slate-600">Mosquitto です。REST 更新を MQTT / MQTT-WS でブロードキャストします。</td>
                <td class="py-3 pr-4 text-slate-600">1883 / 9001 を使用します。無効化したい場合は <code>MQTT_ENABLED=false</code> に設定します。</td>
            </tr>
            </tbody>
        </table>
    </div>
    <p class="text-sm text-slate-500">HTTP(8080) と HTTPS(8443) は常に同時起動します。利用しないプロトコルがある場合は OS 側のファイアウォールで該当ポートを閉じてください。</p>
</section>

<section class="grid md:grid-cols-2 gap-6">
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-3">
        <h3 class="text-xl font-semibold">FastAPIレイヤー</h3>
        <p class="text-slate-600">8 つのルーターをモジュール化し、APScheduler がバックグラウンドジョブを統括します。</p>
        <ul class="list-disc ml-5 text-slate-600 space-y-1">
            <li><code>routers/flows.py</code> に REST PATCH と Checker API を集約しています。</li>
            <li>NMOS 連携は <code>routers/nmos.py</code> と <code>services/nmos</code> が担当します。</li>
            <li>ログは <code>LOG_DIR</code>（既定では <code>/log</code>。権限が無い場合は <code>./logs</code> にフォールバック）配下の <code>api.log</code> と <code>audit.log</code> に保存します。</li>
        </ul>
    </article>
    <article class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-3">
        <h3 class="text-xl font-semibold">PostgreSQL</h3>
        <p class="text-slate-600">schema.sql で初期化されるテーブル構造です。テキストハブ用フィールドは UTF-8 を前提にしています。</p>
        <ul class="list-disc ml-5 text-slate-600 space-y-1">
            <li><code>flows.alias_1-8</code> / <code>user_field_1-8</code> がメモ領域です。</li>
            <li><code>planner_buckets</code> は再帰 CTE で階層を取得します。</li>
            <li>バックアップは <code>docker exec db pg_dump mmam > backup.sql</code> で取得します。</li>
        </ul>
    </article>
</section>

<section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 space-y-6">
    <h3 class="text-2xl font-semibold">通信フローの全体像</h3>
    <p class="text-slate-700 leading-relaxed">
        各サービスがどのように連携して動作するかを順を追って説明します。
    </p>
    <ol class="list-decimal ml-5 text-slate-700 space-y-3">
        <li>
            <strong>ブラウザからUIへアクセス</strong><br>
            <span class="text-sm text-slate-600"><code>https://localhost:4174</code>（または 4173）にアクセスすると、Vue 3 で構築された UI が表示されます。UI は API ベース URL を自動的に判別します。</span>
        </li>
        <li>
            <strong>UI から REST API へリクエスト</strong><br>
            <span class="text-sm text-slate-600">ユーザーがフローを作成・更新すると、UI は FastAPI（8443）へ POST/PATCH リクエストを送信します。TLS 証明書は <code>certs/</code> ディレクトリで管理されています。</span>
        </li>
        <li>
            <strong>FastAPI が PostgreSQL を操作</strong><br>
            <span class="text-sm text-slate-600">FastAPI は PostgreSQL へクエリを発行し、フローやバケット情報を保存・取得します。変更があった場合は同時に MQTT へイベントを配信します。</span>
        </li>
                <li>
                    <strong>バックグラウンドジョブの実行</strong><br>
                    <span class="text-sm text-slate-600">Checker や NMOS 連携ジョブは APScheduler によってスケジュールされ、定期的に実行されます。実行結果は DB の <code>scheduled_jobs</code> テーブルに保存され、Automation UI と <code>/api/automation/summary</code> から参照できます。</span>
                </li>
    </ol>
    <p class="text-sm text-slate-500 mt-4">
        <strong>セキュリティのヒント:</strong> 本番環境では、UI→API 間を社内 CA の証明書で暗号化し、API→DB 間は Docker の内部ネットワークに閉じて外部からアクセスできないようにしてください。
    </p>
</section>

            </main>
        </div>
    </div>
    <script src="../js/guide.js"></script>
</body>
</html>
