<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MMAM Control Panel</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="vendor/inter-font.css">
    <script src="vendor/tailwind-cdn.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter Variable"', 'Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        };
    </script>
    <script src="sample-data-mmam.js"></script>
    <script src="mock-api-mmam.js"></script>
    <script src="fetch-interceptor.js"></script>
</head>
<body class="bg-slate-100 text-slate-900 font-sans">
    <div id="app" class="min-h-screen flex bg-slate-100 relative">
        <aside class="w-64 bg-slate-900 text-white flex flex-col">
            <div class="px-6 py-5 border-b border-white/10 flex items-center gap-3">
                <svg width="56" height="56" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
                    <rect x="4" y="4" width="56" height="56" rx="14" fill="#1e293b"/>
                    <g fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="32" cy="28" r="8" stroke="#60a5fa" stroke-width="3"/>
                        <path d="M20 44 A16 16 0 0 1 44 44" stroke="#3b82f6" stroke-width="3"/>
                        <circle cx="20" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
                        <circle cx="32" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
                        <circle cx="44" cy="44" r="4" fill="#1e293b" stroke="#60a5fa" stroke-width="3"/>
                    </g>
                </svg>
                <div>
                    <h1 class="text-xl font-semibold">MMAM</h1>
                    <p class="text-xs text-slate-300">media multicast address manager</p>
                </div>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2 text-sm">
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='dashboard' && 'bg-white/20'" @click="navigate('dashboard')">
                    Dashboard / „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='flows' && 'bg-white/20'" @click="navigate('flows')">
                    Flows / „Éï„É≠„Éº‰∏ÄË¶ß
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='search' && 'bg-white/20'" @click="navigate('search')">
                    Search / Ê§úÁ¥¢
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='newFlow' && 'bg-white/20'" @click="navigate('newFlow')">
                    New Flow / Êñ∞Ë¶è„Éï„É≠„Éº
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='wizard' && 'bg-white/20'" @click="navigate('wizard')">
                    NMOS Wizard / „Ç§„É≥„Éù„Éº„Éà
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='planner' && 'bg-white/20'" @click="navigate('planner')">
                    Planner / „Éó„É©„É≥„Éä„Éº
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='checker' && 'bg-white/20'" @click="navigate('checker')">
                    Checker / „ÉÅ„Çß„ÉÉ„ÇØ
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='users' && 'bg-white/20'" @click="navigate('users')">
                    Users / „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='settings' && 'bg-white/20'" @click="navigate('settings')">
                    Settings / Ë®≠ÂÆö
                </button>
            </nav>
            <div class="px-4 py-4 border-t border-white/10 text-xs">
                <p>{{ currentUser ? currentUser.username : "Guest" }} ({{ currentUser ? currentUser.role : "viewer" }})</p>
                <button class="mt-2 px-3 py-1 bg-white/20 rounded text-sm w-full" @click="logout" v-if="token">Log out</button>
            </div>
        </aside>
        <transition name="toast-fade">
            <div
                v-if="notification"
                class="fixed inset-0 flex items-start justify-center pointer-events-none"
            >
                <div
                    class="mt-16 px-4 py-2 rounded text-sm text-white shadow-lg"
                    :class="notification.type === 'error' ? 'bg-black/70' : 'bg-slate-800/70'"
                >
                    {{ notification.message }}
                </div>
            </div>
        </transition>
        <div class="flex-1 flex flex-col">
            <header class="bg-white shadow px-6 py-4 flex items-center justify-between gap-6">
                <div>
                    <h1 class="text-xl font-semibold">MMAM Dashboard</h1>
                    <p class="text-sm text-slate-500">ST2110 Flow Management</p>
                </div>
                    <div class="ml-auto flex items-center gap-4">
                    <button
                        v-if="token"
                        class="px-3 py-2 text-xs rounded border border-slate-300 text-slate-600 hover:bg-slate-50"
                        @click="reloadUiPreserveSession"
                    >
                        Reload UI
                    </button>
                    <div v-if="token" class="text-right">
                        <p class="text-sm font-semibold">
                            {{ currentUser ? currentUser.username : "Logged in" }}
                        </p>
                        <p class="text-xs text-slate-500">
                            {{ currentUser ? currentUser.role : "" }}
                        </p>
                    </div>
                    <button
                        v-if="token"
                        class="px-3 py-2 text-sm rounded border border-slate-300 text-slate-700 hover:bg-slate-50"
                        @click="logout"
                    >
                        Log out
                    </button>
                    <form v-else class="flex items-center gap-2 text-sm" @submit.prevent="login">
                        <input
                            type="text"
                            placeholder="username"
                            class="border rounded px-3 py-2"
                            v-model="loginForm.username"
                        />
                        <input
                            type="password"
                            placeholder="password"
                            class="border rounded px-3 py-2"
                            v-model="loginForm.password"
                        />
                        <button
                            type="submit"
                            class="bg-emerald-600 text-white rounded px-3 py-2"
                        >
                            Log in
                        </button>
                    </form>
                </div>
            </header>
        <main class="flex-1 p-6 overflow-auto space-y-6">
            <div class="bg-blue-600 text-white px-6 py-3 text-sm flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="font-semibold">üé≠ Demo Mode</span>
                    <span>This is a live demonstration. All data is stored in your browser. No backend required.</span>
                </div>
                <button onclick="window.mockAPI.reset(); window.location.reload()" class="px-3 py-1 bg-white/20 rounded hover:bg-white/30">
                    Reset Data
                </button>
            </div>
            <template v-if="currentView==='dashboard'">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <section class="bg-white p-4 rounded shadow-lg space-y-3">
                    <h2 class="font-semibold text-lg">Summary</h2>
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-slate-100 rounded p-3">
                            <div class="text-2xl font-bold">{{ summary.total }}</div>
                            <div class="text-xs text-slate-500">Total Flows</div>
                        </div>
                        <div class="bg-slate-100 rounded p-3">
                            <div class="text-2xl font-bold text-emerald-600">{{ summary.active }}</div>
                            <div class="text-xs text-slate-500">Active</div>
                        </div>
                    </div>
                </section>
                <section v-if="realtime.enabled" class="bg-white p-4 rounded shadow-lg space-y-3">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-lg">Realtime Updates</h2>
                        <span class="text-xs text-slate-500" v-if="realtime.connected">connected</span>
                        <span class="text-xs text-slate-400" v-else>offline</span>
                    </div>
                    <div class="text-xs text-slate-500" v-if="!realtimeFeed.length">
                        No MQTT events received yet.
                    </div>
                    <ul v-else class="space-y-2 max-h-48 overflow-auto text-sm">
                        <li
                            v-for="item in realtimeFeed"
                            :key="item.id"
                            class="border border-slate-200 rounded p-2 text-slate-700"
                        >
                            <p class="font-semibold text-sm truncate">{{ item.display }}</p>
                            <p class="text-[11px] text-slate-500">
                                {{ item.action }} ‚Ä¢ {{ item.timestamp }}
                                <span v-if="item.diffKeys.length" class="ml-1 text-slate-400">
                                    ({{ item.diffKeys.join(", ") }})
                                </span>
                            </p>
                        </li>
                    </ul>
                </section>
                <section class="bg-white p-4 rounded shadow-lg space-y-3">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-lg">Latest Check Results / ÊúÄÊñ∞„ÉÅ„Çß„ÉÉ„ÇØÁµêÊûú</h2>
                        <button
                            v-if="automationSummary"
                            class="text-xs text-slate-500 hover:text-slate-700"
                            @click="loadAutomationSummary"
                        >
                            üîÑ Refresh
                        </button>
                    </div>
                    <div v-if="automationSummary" class="space-y-3">
                        <div class="bg-amber-50 border border-amber-200 rounded p-3 text-center">
                            <div class="text-3xl font-bold text-amber-600">
                                {{ automationSummary.total_alerts }}
                            </div>
                            <div class="text-xs text-amber-700">Total Alerts / „Ç¢„É©„Éº„É†ÂêàË®à</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-center text-sm">
                            <div class="bg-slate-50 rounded p-3">
                                <div class="text-xl font-bold text-red-600">
                                    {{ automationSummary.collision_count }}
                                </div>
                                <div class="text-xs text-slate-600">Collisions / „Ç≥„É™„Ç∏„Éß„É≥</div>
                            </div>
                            <div class="bg-slate-50 rounded p-3">
                                <div class="text-xl font-bold text-orange-600">
                                    {{ automationSummary.nmos_difference_count }}
                                </div>
                                <div class="text-xs text-slate-600">NMOS Diffs / NMOSÂ∑ÆÂàÜ</div>
                            </div>
                        </div>
                        <div class="text-xs text-slate-400 text-center">
                            Last updated: {{ formatTimestamp(automationSummary && automationSummary.last_updated) }}
                        </div>
                        <div class="text-center">
                            <button
                                class="text-sm text-blue-600 hover:text-blue-800 underline"
                                @click="navigate('checker')"
                            >
                                View Details / Ë©≥Á¥∞„ÇíÁ¢∫Ë™ç ‚Üí
                            </button>
                        </div>
                    </div>
                    <div v-else class="text-center py-6 text-slate-400 text-sm">
                        <p>No check results yet.</p>
                        <p class="text-xs">„ÉÅ„Çß„ÉÉ„ÇØÊú™ÂÆüË°å</p>
                        <button
                            class="mt-3 text-sm text-blue-600 hover:text-blue-800 underline"
                            @click="navigate('checker')"
                        >
                            Run Checks / „ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å ‚Üí
                        </button>
                    </div>
                </section>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <section class="bg-white rounded shadow-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-semibold text-lg">Flows / „Éï„É≠„Éº‰∏ÄË¶ß</h2>
                        <div class="flex flex-wrap gap-2">
                            <input type="number" min="1" max="500" class="w-20 border rounded px-2 py-1 text-sm bg-white" v-model.number="filters.limit" />
                            <input type="number" min="0" class="w-20 border rounded px-2 py-1 text-sm bg-white" v-model.number="filters.offset" />
                            <select class="border rounded px-2 py-1 text-sm" v-model="filters.sort_by">
                                <option v-for="option in sortFields" :key="option.value" :value="option.value">
                                    {{ option.label }}
                                </option>
                            </select>
                            <select class="border rounded px-2 py-1 text-sm" v-model="filters.sort_order">
                                <option value="desc">Descending</option>
                                <option value="asc">Ascending</option>
                            </select>
                            <button class="px-3 py-1 bg-slate-900 text-white rounded text-sm" @click="refreshFlows">Refresh</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-3 text-xs text-slate-600 mb-3">
                        <span>Page / „Éö„Éº„Ç∏</span>
                        <input type="number" min="1" class="w-20 border rounded px-2 py-1 bg-white" v-model="pageInput" />
                        <button class="px-3 py-1 rounded text-white bg-slate-900 text-xs hover:bg-slate-800 transition" @click="applyPageInput">Go / ÁßªÂãï</button>
                        <button class="px-3 py-1 rounded text-xs transition"
                            :class="canGoPrevious ? 'bg-slate-900 text-white hover:bg-slate-800 border border-slate-900' : 'bg-slate-100 text-slate-400 border border-slate-200 cursor-not-allowed'"
                            @click="prevPage"
                            :disabled="!canGoPrevious">
                            Previous / Ââç„Å∏
                        </button>
                        <button class="px-3 py-1 rounded text-xs transition"
                            :class="canGoNext ? 'bg-slate-900 text-white hover:bg-slate-800 border border-slate-900' : 'bg-slate-100 text-slate-400 border border-slate-200 cursor-not-allowed'"
                            @click="nextPage"
                            :disabled="!canGoNext">
                            Next / Ê¨°„Å∏
                        </button>
                        <span class="text-[11px] text-slate-500">Current: {{ currentPageNumber }}</span>
                    </div>
                    <div class="space-y-2 max-h-[420px] overflow-auto">
                        <article v-for="flow in flows" :key="flow.flow_id" class="border rounded p-3 flex justify-between items-start">
                            <div>
                                <h3 class="font-semibold flex items-center gap-1">
                                    <span>{{ flow.display_name || flow.flow_id }}</span>
                                    <span v-if="flow.locked" class="text-slate-500 text-base leading-none">‚öø</span>
                                </h3>
                                <p v-if="flow.nmos_node_label" class="text-xs text-slate-500 mt-0.5">{{ flow.nmos_node_label }}</p>
                                <p class="text-xs text-slate-500">{{ flow.flow_status }} / {{ flow.availability }}</p>
                                <p class="text-xs text-slate-400">Updated: {{ flow.updated_at }}</p>
                            </div>
                            <div class="flex flex-col gap-1">
                                <button class="text-xs text-slate-600 underline" @click="showFlow(flow.flow_id)">Details</button>
                                <button class="text-xs text-emerald-600 underline" @click="loadFlowForEdit(flow.flow_id)">Edit</button>
                            </div>
                        </article>
                        <p v-if="flows.length === 0" class="text-sm text-slate-500">No flows found.</p>
                    </div>
                </section>
                <section class="bg-white rounded shadow-lg p-4">
                    <h2 class="font-semibold text-lg mb-2">Debug Console</h2>
                    <pre class="bg-slate-900 text-slate-100 text-xs rounded p-3 max-h-60 overflow-auto">{{ logs.join("\n") }}</pre>
                </section>
            </div>
            </template>

            <template v-else-if="currentView==='planner'">
                <section class="space-y-4">
                    <div class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div class="flex flex-wrap gap-3 border-b border-slate-200 pb-2 text-sm">
                            <button
                                class="px-4 py-2 font-medium transition"
                                :class="planner.tab==='view' ? 'text-slate-900 border-b-2 border-slate-900' : 'text-slate-500 border-b-2 border-transparent hover:text-slate-700'"
                                @click="planner.tab='view'"
                            >
                                Explorer
                            </button>
                            <button
                                class="px-4 py-2 font-medium transition"
                                :class="planner.tab==='manage' ? 'text-slate-900 border-b-2 border-slate-900' : 'text-slate-500 border-b-2 border-transparent hover:text-slate-700'"
                                @click="planner.tab='manage'"
                            >
                                Manage
                            </button>
                            <button
                                class="px-4 py-2 font-medium transition"
                                :class="planner.tab==='easy' ? 'text-slate-900 border-b-2 border-slate-900' : 'text-slate-500 border-b-2 border-transparent hover:text-slate-700'"
                                @click="planner.tab='easy'"
                            >
                                Easy view
                            </button>
                            <button
                                class="px-4 py-2 font-medium transition"
                                :class="planner.tab==='backup' ? 'text-slate-900 border-b-2 border-slate-900' : 'text-slate-500 border-b-2 border-transparent hover:text-slate-700'"
                                @click="planner.tab='backup'"
                            >
                                Backup
                            </button>
                        </div>
                        <div v-if="planner.tab==='view'" class="space-y-4">
                            <p class="text-xs text-slate-500">Choose a drive (/8) ‚Üí folder (parent) ‚Üí view (child) to render the address grid.</p>
                            <div class="grid gap-4 lg:grid-cols-[280px_1fr]">
                                <aside class="bg-white border rounded-lg p-3 space-y-3 shadow">
                                    <div>
                                        <p class="text-sm font-semibold">Root /8</p>
                                        <select
                                            class="mt-2 w-full border rounded px-3 py-2 text-sm bg-white"
                                            :value="planner.selectedDriveId || ''"
                                            @change="handleDriveChange"
                                        >
                                            <option v-for="drive in planner.drives" :key="drive.id" :value="drive.id">
                                                {{ drive.description || (drive.start_ip + ' /8') }}
                                            </option>
                                        </select>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold">Folders</p>
                                        <div class="mt-2 max-h-[420px] overflow-auto border rounded bg-slate-50 p-2 space-y-1">
                                            <button
                                                class="w-full text-left px-3 py-2 rounded border text-xs mb-2"
                                                :class="planner.selectedFolderId===planner.selectedDriveId ? 'bg-slate-900 text-white border-slate-900' : 'border-slate-300 text-slate-600 hover:bg-slate-100'"
                                                @click="planner.selectedFolderId = planner.selectedDriveId"
                                            >
                                                {{ driveLabel(planner.drives.find(d => d.id === planner.selectedDriveId)) || 'Root' }}
                                            </button>
                                            <div v-for="row in plannerFolderTree" :key="row.node.id" class="flex items-center gap-2">
                                            <button
                                                class="flex-1 text-left px-3 py-1 rounded border text-xs"
                                                :style="{ marginLeft: `${row.level * 16}px` }"
                                                :class="row.node.id===planner.selectedFolderId ? 'bg-slate-900 text-white border-slate-900' : 'border-slate-300 text-slate-600 hover:bg-slate-100'"
                                                @click="selectFolder(row.node)"
                                            >
                                                <span class="block font-semibold">{{ row.node.description || (row.node.start_ip + ' ‚Äì ' + row.node.end_ip) }}</span>
                                                <span class="block text-[10px] text-slate-400">
                                                    <template v-if="row.node.cidr">{{ row.node.cidr }} ‚Ä¢ </template>
                                                    {{ row.node.start_ip }} ‚Äì {{ row.node.end_ip }}
                                                </span>
                                            </button>
                                                <button
                                                    v-if="canExpandFolder(row.node)"
                                                    class="text-[10px] px-2 py-1 rounded border font-semibold transition relative overflow-hidden"
                                                    :class="[
                                                        isFolderExpanded(row.node.id)
                                                            ? 'bg-slate-900 text-white border-slate-900'
                                                            : hasLoadedChildFolders(row.node.id)
                                                                ? 'bg-white text-slate-600 border-slate-400 hover:bg-slate-100 folder-hint-border'
                                                                : 'bg-white text-slate-600 border-slate-400 hover:bg-slate-100'
                                                    ]"
                                                    :title="isFolderExpanded(row.node.id) ? 'Collapse folder' : 'Expand folder'"
                                                    @click.stop="toggleFolder(row.node)"
                                                >
                                                    {{ isFolderExpanded(row.node.id) ? '‚Äì' : '+' }}
                                                </button>
                                                <span
                                                    v-else
                                                    class="text-[10px] px-2 py-1 rounded border border-dashed text-slate-300 bg-slate-100 cursor-not-allowed"
                                                    title="No nested folders available"
                                                >
                                                    ‚Äî
                                                </span>
                                            </div>
                                            <p v-if="!plannerFolderTree.length" class="text-xs text-slate-400 text-center py-2">No parent folders found.</p>
                                        </div>
                                    </div>
                                </aside>
                                <section class="space-y-4">
                                    <div class="bg-white border rounded-lg p-3 shadow space-y-2">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm font-semibold">Views in folder</p>
                                                <p class="text-xs text-slate-500">{{ plannerFolderBreadcrumb || 'Drive root' }}</p>
                                            </div>
                                            <span class="text-xs text-slate-500">{{ currentFolderFiles.length }} views</span>
                                        </div>
                                        <div v-if="currentFolderFiles.length" class="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
                                            <button
                                                v-for="view in currentFolderFiles"
                                                :key="view.id"
                                                class="border rounded px-3 py-2 text-left text-xs hover:bg-slate-50"
                                                :class="planner.selectedView && planner.selectedView.id===view.id ? 'border-emerald-400 bg-emerald-50' : 'border-slate-200'"
                                                @click="openPlannerView(view)"
                                            >
                                                <p class="font-semibold flex items-center gap-1">
                                                    <span>{{ plannerFileIcon(view) }}</span>
                                                    <span>{{ view.description || (view.start_ip + ' ‚Äì ' + view.end_ip) }}</span>
                                                </p>
                                                <p class="text-[11px] text-slate-500">
                                                    <template v-if="view.cidr">{{ view.cidr }} ‚Ä¢ </template>
                                                    {{ view.start_ip }} ‚Äì {{ view.end_ip }}
                                                </p>
                                            </button>
                                        </div>
                                        <p v-else class="text-xs text-slate-400">No views in this folder.</p>
                                    </div>
                                    <div class="bg-white border rounded-lg p-4 shadow space-y-3">
                                        <div class="flex flex-wrap items-center gap-3 text-xs text-slate-500">
                                            <span v-if="planner.selectedView">Viewing: {{ planner.selectedView.start_ip }} ‚Äì {{ planner.selectedView.end_ip }}</span>
                                            <label class="flex items-center gap-2">
                                                Search size
                                                <input type="number" min="1" max="255" class="w-16 border rounded px-2 py-1" v-model.number="planner.searchSize" />
                                            </label>
                                            <label class="flex items-center gap-2">
                                                Center address
                                                <input type="text" class="border rounded px-2 py-1" v-model="planner.centerAddressInput" placeholder="232.0.0.12" />
                                            </label>
                                            <button class="px-3 py-1 border rounded" @click="plannerCenterOnInput" :disabled="!planner.centerAddressInput">Go</button>
                                            <span v-if="planner.error" class="text-red-600">{{ planner.error }}</span>
                                        </div>
                                        <div v-if="planner.isLoading" class="text-xs text-slate-500">Loading view...</div>
                                        <div v-else-if="planner.detailCells.length" class="border rounded bg-slate-50 p-3">
                                            <div
                                                v-for="row in plannerDetailRows"
                                                :key="row.key"
                                                class="space-y-0"
                                                :style="plannerRowStyle(row)"
                                            >
                                                <div
                                                    v-if="row.segmentLabel && row.showLabel"
                                                    class="text-[11px] text-slate-400"
                                                >
                                                    {{ row.segmentLabel }}
                                                </div>
                                                <div class="flex flex-wrap gap-[2px]">
                                                <span
                                                    v-for="n in row.leading"
                                                    :key="`lead-${row.key}-${n}`"
                                                    class="inline-block"
                                                    style="width:12px;height:12px;visibility:hidden"
                                                ></span>
                                                <span
                                                    v-for="cell in row.cells"
                                                    :key="cell.index"
                                                    class="inline-block cursor-pointer"
                                                    :style="plannerCellStyle(cell)"
                                                    @mouseenter="handlePlannerHover(cell, $event)"
                                                    @mousemove="handlePlannerHoverMove($event)"
                                                    @mouseleave="clearPlannerHover"
                                                    @click="selectPlannerCell(cell)"
                                                    @dblclick="emphasizePlannerCell(cell)"
                                                ></span>
                                                <span
                                                    v-for="n in row.trailing"
                                                    :key="`trail-${row.key}-${n}`"
                                                    class="inline-block"
                                                    style="width:12px;height:12px;visibility:hidden"
                                                ></span>
                                                </div>
                                            </div>
                                        </div>
                                        <p v-else class="text-xs text-slate-400 border rounded bg-slate-50 p-3">Select a view to display the grid.</p>
                                        <div class="grid gap-3 lg:grid-cols-2 text-xs">
                                            <div class="bg-slate-50 border rounded p-3">
                                                <div class="flex items-center justify-between mb-2">
                                                    <p class="font-semibold">Cell Detail</p>
                                                    <button v-if="planner.selectedCell" @click="clearSelectedCell" class="text-[10px] text-slate-500 underline">Clear</button>
                                                </div>
                                                <div v-if="planner.selectedCell" class="space-y-2 text-xs">
                                                    <div class="border-b pb-2">
                                                        <p class="text-slate-500">Address</p>
                                                        <div class="flex items-center gap-2">
                                                            <p class="font-mono text-sm font-semibold">{{ planner.selectedCell.address }}</p>
                                                            <button @click="copyToClipboard(planner.selectedCell.address)" class="text-[11px] px-2 py-1 border rounded text-slate-600 hover:bg-slate-100">Copy</button>
                                                        </div>
                                                    </div>
                                                    <div class="border-b pb-2">
                                                        <p class="text-slate-500">Status</p>
                                                        <p class="font-semibold">{{ planner.selectedCell.state }}</p>
                                                    </div>
                                                    <div v-if="planner.selectedCell.flows && planner.selectedCell.flows.length" class="space-y-1">
                                                        <p class="text-slate-500 font-semibold">Flows ({{ planner.selectedCell.flows.length }})</p>
                                                        <div v-for="flow in planner.selectedCell.flows" :key="flow.flow_id" class="border rounded p-2 bg-white">
                                                            <div class="flex items-start justify-between gap-2">
                                                                <div class="flex-1 min-w-0">
                                                                    <p class="font-semibold text-[11px] truncate">{{ flow.display_name || flow.flow_id }}</p>
                                                                    <p class="text-[10px] text-slate-500">{{ flow.flow_status }} / {{ flow.availability }}</p>
                                                                    <p v-if="flow.nmos_node_label" class="text-[10px] text-slate-400 truncate">{{ flow.nmos_node_label }}</p>
                                                                </div>
                                                                <button @click="showFlow(flow.flow_id)" class="text-xs text-slate-600 underline whitespace-nowrap">Details</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p v-else class="text-slate-400 text-[11px]">No flows using this address.</p>
                                                </div>
                                                <p v-else class="text-slate-400 text-[11px]">Click a cell to see details. Hover for quick info.</p>
                                            </div>
                                            <div class="bg-slate-50 border rounded p-3 min-h-[80px]">
                                                <p class="font-semibold mb-1">Usage legend</p>
                                                <div class="flex items-center gap-3">
                                                    <span class="inline-flex items-center gap-1 text-emerald-700"><span class="inline-block w-3 h-3 rounded bg-emerald-400/60"></span>FREE</span>
                                                    <span class="inline-flex items-center gap-1 text-orange-600"><span class="inline-block w-3 h-3 rounded bg-amber-400/50"></span>RESERVED</span>
                                                    <span class="inline-flex items-center gap-1 text-rose-600"><span class="inline-block w-3 h-3 rounded bg-rose-400/60"></span>USED</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            v-if="planner.hoverTooltip.visible && planner.hoverInfo"
                                            class="fixed z-50 pointer-events-none bg-white/95 border border-slate-300 rounded shadow-lg text-xs text-slate-700 w-56"
                                            :style="{ top: planner.hoverTooltip.y + 'px', left: planner.hoverTooltip.x + 'px' }"
                                        >
                                            <div class="px-3 py-2 border-b">
                                                <p class="font-semibold">Address</p>
                                                <p class="font-mono text-[11px]">{{ planner.hoverInfo.address }}</p>
                                            </div>
                                            <div class="px-3 py-2 border-b">
                                                <p class="font-semibold">Status</p>
                                                <p>{{ planner.hoverInfo.state }}</p>
                                            </div>
                                            <div class="px-3 py-2" v-if="planner.hoverInfo.flows && planner.hoverInfo.flows.length">
                                                <p class="font-semibold mb-1">Flows</p>
                                                <p
                                                    v-for="flow in planner.hoverInfo.flows"
                                                    :key="flow.flow_id"
                                                    class="truncate"
                                                >
                                                    {{ flow.display_name || flow.flow_id }}
                                                </p>
                                            </div>
                                            <div class="px-3 py-2 text-slate-400" v-else>No flow information.</div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </div>
                        <div v-else-if="planner.tab==='manage'" class="space-y-4">
                            <p class="text-xs text-slate-500">Use the shared drive/folder tree to manage addresses directly. Select a target on the left and perform the action on the right.</p>
                            <div class="grid gap-4 lg:grid-cols-[280px_1fr]">
                                <aside class="bg-white border rounded-lg p-3 space-y-3 shadow">
                                    <div>
                                        <p class="text-sm font-semibold">Root /8</p>
                                        <select
                                            class="mt-2 w-full border rounded px-3 py-2 text-sm bg-white"
                                            :value="planner.selectedDriveId || ''"
                                            @change="handleDriveChange"
                                        >
                                            <option v-for="drive in planner.drives" :key="drive.id" :value="drive.id">
                                                {{ drive.description || (drive.start_ip + ' /8') }}
                                            </option>
                                        </select>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold">Folders</p>
                                        <div class="mt-2 max-h-[420px] overflow-auto border rounded bg-slate-50 p-2 space-y-1">
                                            <button
                                                class="w-full text-left px-3 py-2 rounded border text-xs mb-2"
                                                :class="planner.selectedFolderId===planner.selectedDriveId ? 'bg-slate-900 text-white border-slate-900' : 'border-slate-300 text-slate-600 hover:bg-slate-100'"
                                                @click="planner.selectedFolderId = planner.selectedDriveId"
                                            >
                                                {{ driveLabel(planner.drives.find(d => d.id === planner.selectedDriveId)) }}
                                            </button>
                                            <div v-for="row in plannerFolderTree" :key="row.node.id" class="flex items-center gap-2">
                                            <button
                                                class="flex-1 text-left px-3 py-1 rounded border text-xs"
                                                :style="{ marginLeft: `${row.level * 16}px` }"
                                                :class="row.node.id===planner.selectedFolderId ? 'bg-slate-900 text-white border-slate-900' : 'border-slate-300 text-slate-600 hover:bg-slate-100'"
                                                @click="selectFolder(row.node)"
                                            >
                                                <span class="block font-semibold">{{ row.node.description || (row.node.start_ip + ' ‚Äì ' + row.node.end_ip) }}</span>
                                                <span class="block text-[10px] text-slate-400">
                                                    <template v-if="row.node.cidr">{{ row.node.cidr }} ‚Ä¢ </template>
                                                    {{ row.node.start_ip }} ‚Äì {{ row.node.end_ip }}
                                                </span>
                                            </button>
                                                <button
                                                    v-if="canExpandFolder(row.node)"
                                                    class="text-[10px] px-2 py-1 rounded border font-semibold transition relative overflow-hidden"
                                                    :class="[
                                                        isFolderExpanded(row.node.id)
                                                            ? 'bg-slate-900 text-white border-slate-900'
                                                            : hasLoadedChildFolders(row.node.id)
                                                                ? 'bg-white text-slate-600 border-slate-400 hover:bg-slate-100 folder-hint-border'
                                                                : 'bg-white text-slate-600 border-slate-400 hover:bg-slate-100'
                                                    ]"
                                                    :title="isFolderExpanded(row.node.id) ? 'Collapse folder' : 'Expand folder'"
                                                    @click.stop="toggleFolder(row.node)"
                                                >
                                                    {{ isFolderExpanded(row.node.id) ? '‚Äì' : '+' }}
                                                </button>
                                                <span
                                                    v-else
                                                    class="text-[10px] px-2 py-1 rounded border border-dashed text-slate-300 bg-slate-100 cursor-not-allowed"
                                                    title="No nested folders available"
                                                >
                                                    ‚Äî
                                                </span>
                                            </div>
                                            <p v-if="!plannerFolderTree.length" class="text-xs text-slate-400 text-center py-2">No parent folders found.</p>
                                        </div>
                                    </div>
                                </aside>
                                <section class="space-y-4">
                                    <div class="bg-white border rounded-lg p-4 shadow space-y-3">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm font-semibold">Selected Folder</p>
                                                <p class="text-xs text-slate-500">{{ currentFolderLabel }}</p>
                                                <p v-if="currentFolderNode" class="text-[11px] text-slate-400">{{ currentFolderNode.start_ip }} ‚Äì {{ currentFolderNode.end_ip }}</p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button class="px-3 py-1 rounded border text-xs" :class="selectedFolderCanEdit ? 'border-slate-900 text-slate-900' : 'border-slate-200 text-slate-300 cursor-not-allowed'" :disabled="!selectedFolderCanEdit" @click="startFolderEdit">Edit</button>
                                                <button class="px-3 py-1 rounded border text-xs text-red-600" :class="selectedFolderCanDelete ? 'border-red-300 hover:bg-red-50' : 'border-slate-200 text-slate-300 cursor-not-allowed'" :disabled="!selectedFolderCanDelete" @click="deleteFolder">Delete</button>
                                            </div>
                                        </div>
                                        <div v-if="planner.manageFolderEditing" class="space-y-3 text-xs text-slate-600">
                                            <div v-if="currentFolderNode && currentFolderNode.kind === 'parent' && selectableParentFolders.length > 0" class="flex flex-col gap-1">
                                                <span>Parent Folder</span>
                                                <select class="w-full border rounded px-3 py-2 text-sm bg-white" v-model="planner.manageFolderForm.parent_id">
                                                    <option :value="currentFolderNode.parent_id">{{ currentParentFolderLabel }} (current)</option>
                                                    <option v-for="folder in selectableParentFolders" :key="folder.id" :value="folder.id">
                                                        {{ folder.description || folder.cidr || `${folder.start_ip} - ${folder.end_ip}` }}
                                                    </option>
                                                </select>
                                            </div>
                                            <div class="flex flex-col gap-1">
                                                <span>Description</span>
                                                <input type="text" class="w-full border rounded px-3 py-2 text-sm" v-model="planner.manageFolderForm.description" />
                                            </div>
                                            <div class="flex flex-col gap-1">
                                                <span>Memo</span>
                                                <textarea class="w-full border rounded px-3 py-2 text-sm resize-y" rows="2" v-model="planner.manageFolderForm.memo"></textarea>
                                            </div>
                                            <div class="flex gap-2">
                                                <button class="px-3 py-2 rounded bg-emerald-600 text-white text-xs" @click="saveFolderEdit">Save</button>
                                                <button class="px-3 py-2 rounded border text-xs" @click="cancelFolderEdit">Cancel</button>
                                            </div>
                                        </div>
                                        <p v-else class="text-xs text-slate-500">Select a folder to edit its metadata or delete it.</p>
                                    </div>
                                    <div class="bg-white border rounded-lg p-4 shadow space-y-4">
                                        <div>
                                            <h3 class="font-semibold text-sm">Create Folder (Parent)</h3>
                                            <p class="text-xs text-slate-500">Target parent: {{ manageParentTargetLabel }}</p>
                                        </div>
                                        <div class="flex flex-wrap gap-3 text-xs text-slate-600 items-end">
                                            <label class="flex flex-col gap-1">
                                                <span class="text-[11px] uppercase tracking-wide text-slate-500">Mode</span>
                                                <select class="border rounded px-3 py-2 text-sm w-48" v-model="planner.parentForm.mode">
                                                    <option value="cidr">CIDR</option>
                                                    <option value="manual">Manual range</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="border border-slate-200 rounded p-3 bg-slate-50 space-y-2 text-xs text-slate-600">
                                            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Address range</p>
                                            <label v-if="planner.parentForm.mode==='cidr'">
                                                CIDR
                                                <input type="text" class="mt-1 border rounded px-3 py-2 text-sm w-full" v-model="planner.parentForm.cidr" placeholder="232.0.0.0/24" />
                                            </label>
                                            <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <label>Start IP<input type="text" class="mt-1 border rounded px-3 py-2 text-sm w-full" v-model="planner.parentForm.start_ip" placeholder="232.0.0.0" /></label>
                                                <label>End IP<input type="text" class="mt-1 border rounded px-3 py-2 text-sm w-full" v-model="planner.parentForm.end_ip" placeholder="232.0.255.255" /></label>
                                            </div>
                                        </div>
                                        <div class="border border-slate-200 rounded p-3 space-y-3">
                                            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Metadata</p>
                                            <div class="flex flex-col gap-1 text-xs text-slate-600">
                                                <span>Description</span>
                                                <input type="text" class="border rounded px-3 py-2 text-sm w-full" v-model="planner.parentForm.description" />
                                            </div>
                                            <div class="flex flex-col gap-1 text-xs text-slate-600">
                                                <span>Memo</span>
                                                <textarea class="border rounded px-3 py-2 text-sm w-full resize-y" rows="2" v-model="planner.parentForm.memo"></textarea>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-end gap-3">
                                            <p class="text-xs text-red-600" v-if="planner.bucketFormError">{{ planner.bucketFormError }}</p>
                                            <button type="button" class="px-4 py-2 rounded bg-slate-900 text-white text-sm" :disabled="planner.bucketSaving" @click="submitParentBucket">
                                                {{ planner.bucketSaving ? 'Saving...' : 'Create Parent' }}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="bg-white border rounded-lg p-4 shadow space-y-4" :class="!canCreateChildView ? 'opacity-60' : ''">
                                        <div>
                                            <h3 class="font-semibold text-sm">Create View (Child)</h3>
                                            <p class="text-xs text-slate-500">
                                                Target folder: {{ manageChildTargetLabel }}
                                                <span v-if="!canCreateChildView" class="text-red-500 ms-1">(select a parent folder first)</span>
                                            </p>
                                        </div>
                                        <div class="flex flex-wrap gap-3 text-xs text-slate-600 items-end">
                                            <label class="flex flex-col gap-1">
                                                <span class="text-[11px] uppercase tracking-wide text-slate-500">Mode</span>
                                                <select class="border rounded px-3 py-2 text-sm w-48" v-model="planner.childForm.mode" :disabled="!canCreateChildView">
                                                    <option value="cidr">CIDR</option>
                                                    <option value="manual">Manual range</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="border border-slate-200 rounded p-3 bg-slate-50 space-y-2 text-xs text-slate-600">
                                        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Address range</p>
                                            <label v-if="planner.childForm.mode==='cidr'">
                                                CIDR (‚â§4096 addresses)
                                                <input type="text" class="mt-1 border rounded px-3 py-2 text-sm w-full" v-model="planner.childForm.cidr" placeholder="232.0.10.0/26" :disabled="!canCreateChildView" />
                                            </label>
                                            <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <label>Start IP<input type="text" class="mt-1 border rounded px-3 py-2 text-sm w-full" v-model="planner.childForm.start_ip" placeholder="232.0.10.0" :disabled="!canCreateChildView" /></label>
                                                <label>End IP<input type="text" class="mt-1 border rounded px-3 py-2 text-sm w-full" v-model="planner.childForm.end_ip" placeholder="232.0.10.63" :disabled="!canCreateChildView" /></label>
                                            </div>
                                        </div>
                                        <div class="border border-slate-200 rounded p-3 space-y-3">
                                            <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Metadata</p>
                                            <div class="flex flex-col gap-1 text-xs text-slate-600">
                                                <span>Description</span>
                                                <input type="text" class="border rounded px-3 py-2 text-sm w-full" v-model="planner.childForm.description" placeholder="e.g., STUDIO A" :disabled="!canCreateChildView" />
                                            </div>
                                            <div class="flex flex-col gap-1 text-xs text-slate-600">
                                                <span>Memo</span>
                                                <textarea class="border rounded px-3 py-2 text-sm w-full resize-y" rows="2" v-model="planner.childForm.memo" :disabled="!canCreateChildView"></textarea>
                                            </div>
                                            <div class="flex items-center gap-3 text-xs text-slate-600">
                                                <label class="inline-flex items-center gap-2"><input type="checkbox" v-model="planner.childForm.is_reserved" class="rounded border-slate-400" :disabled="!canCreateChildView" />Reserved block</label>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-end gap-3">
                                            <p class="text-xs text-red-600" v-if="planner.bucketFormError">{{ planner.bucketFormError }}</p>
                                            <button type="button" class="px-4 py-2 rounded bg-emerald-600 text-white text-sm disabled:opacity-60" :disabled="planner.bucketSaving || !canCreateChildView" @click="submitChildBucket">
                                                {{ planner.bucketSaving ? 'Saving...' : 'Create View' }}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="bg-white border rounded-lg p-4 shadow space-y-3">
                                        <div class="flex items-center justify-between">
                                            <h3 class="font-semibold text-sm">Views in folder</h3>
                                            <span class="text-xs text-slate-500">{{ currentFolderFiles.length }} views</span>
                                        </div>
                                        <div v-if="currentFolderFiles.length" class="space-y-2">
                                            <article
                                                v-for="view in currentFolderFiles"
                                                :key="view.id"
                                                class="border rounded px-3 py-2 text-xs space-y-2"
                                            >
                                                <div class="flex items-center justify-between gap-2">
                                                    <div>
                                                        <p class="font-semibold">{{ view.description || (view.start_ip + ' ‚Äì ' + view.end_ip) }}</p>
                                                        <p class="text-[11px] text-slate-500">
                                                            <template v-if="view.cidr">{{ view.cidr }} ‚Ä¢ </template>
                                                            {{ view.start_ip }} ‚Äì {{ view.end_ip }}
                                                        </p>
                                                    </div>
                                                    <div class="flex gap-2">
                                                        <button class="px-2 py-1 rounded border text-[11px]" @click.stop="startViewEdit(view)">Edit</button>
                                                        <button class="px-2 py-1 rounded border text-[11px] text-red-600 border-red-200" @click.stop="deleteView(view)">Delete</button>
                                                    </div>
                                                </div>
                                                <div v-if="planner.manageViewEditingId === view.id" class="space-y-2">
                                                    <div v-if="selectableParentFoldersForView.length > 0" class="flex flex-col gap-1">
                                                        <span class="text-[11px] text-slate-600">Parent Folder</span>
                                                        <select class="w-full border rounded px-2 py-1 text-[11px] bg-white" v-model="planner.manageViewForm.parent_id">
                                                            <option :value="view.parent_id">{{ currentViewParentFolderLabel }} (current)</option>
                                                            <option v-for="folder in selectableParentFoldersForView" :key="folder.id" :value="folder.id">
                                                                {{ folder.description || folder.cidr || `${folder.start_ip} - ${folder.end_ip}` }}
                                                            </option>
                                                        </select>
                                                    </div>
                                                    <label class="text-[11px] text-slate-600">Description<input type="text" class="w-full border rounded px-2 py-1" v-model="planner.manageViewForm.description" /></label>
                                                    <label class="text-[11px] text-slate-600">Memo<textarea class="w-full border rounded px-2 py-1" rows="2" v-model="planner.manageViewForm.memo"></textarea></label>
                                                    <label class="inline-flex items-center gap-2 text-[11px] text-slate-600"><input type="checkbox" v-model="planner.manageViewForm.is_reserved" class="rounded border-slate-400" />Reserved block</label>
                                                    <div class="flex gap-2">
                                                        <button class="px-3 py-1 rounded bg-emerald-600 text-white text-[11px]" @click="saveViewEdit">Save</button>
                                                        <button class="px-3 py-1 rounded border text-[11px]" @click="cancelViewEdit">Cancel</button>
                                                    </div>
                                                </div>
                                            </article>
                                        </div>
                                        <p v-else class="text-xs text-slate-400">No views in this folder.</p>
                                    </div>
                                </section>
                            </div>
                        </div>
                        <div v-else-if="planner.tab==='easy'" class="space-y-4">
                            <p class="text-xs text-slate-500">Load an ad-hoc CIDR or manual range (up to 4096 addresses) without creating or saving a view. History is kept until you reload this page.</p>
                            <div class="grid gap-4 lg:grid-cols-[320px_1fr]">
                                <aside class="space-y-4">
                                    <div class="bg-white border rounded-lg p-4 shadow space-y-3">
                                        <div>
                                            <p class="text-sm font-semibold">Range input</p>
                                            <p class="text-xs text-slate-500">Choose CIDR or manual range.</p>
                                        </div>
                                        <label class="text-xs text-slate-600 flex flex-col gap-1">
                                            Mode
                                            <select class="border rounded px-3 py-2 text-sm" v-model="planner.easyView.mode">
                                                <option value="cidr">CIDR (recommended)</option>
                                                <option value="manual">Manual range</option>
                                            </select>
                                        </label>
                                        <div v-if="planner.easyView.mode==='cidr'" class="flex flex-col gap-1 text-xs text-slate-600">
                                            <span>CIDR (‚â§4096 addresses)</span>
                                            <input type="text" class="border rounded px-3 py-2 text-sm" v-model="planner.easyView.cidr" placeholder="239.10.0.0/24" />
                                        </div>
                                        <div v-else class="grid grid-cols-1 gap-2 text-xs text-slate-600">
                                            <label class="flex flex-col gap-1">
                                                Start IP
                                                <input type="text" class="border rounded px-3 py-2 text-sm" v-model="planner.easyView.start_ip" placeholder="239.10.0.0" />
                                            </label>
                                            <label class="flex flex-col gap-1">
                                                End IP
                                                <input type="text" class="border rounded px-3 py-2 text-sm" v-model="planner.easyView.end_ip" placeholder="239.10.15.255" />
                                            </label>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button class="px-4 py-2 rounded bg-slate-900 text-white text-sm disabled:opacity-60" :disabled="planner.easyView.loading" @click="loadEasyViewRange()">
                                                {{ planner.easyView.loading ? 'Loading...' : 'Load range' }}
                                            </button>
                                            <span class="text-xs text-red-600" v-if="planner.easyView.error">{{ planner.easyView.error }}</span>
                                        </div>
                                    </div>
                                    <div class="bg-white border rounded-lg p-4 shadow space-y-3">
                                        <div class="flex items-center justify-between">
                                            <p class="text-sm font-semibold">Recent ranges</p>
                                            <button
                                                v-if="planner.easyView.history.length"
                                                class="text-[11px] text-slate-500 underline"
                                                @click="clearEasyViewHistory"
                                            >
                                                Clear
                                            </button>
                                        </div>
                                        <p class="text-xs text-slate-400" v-if="!planner.easyView.history.length">No history yet.</p>
                                        <div v-else class="space-y-2">
                                            <button
                                                v-for="entry in planner.easyView.history"
                                                :key="entry.id"
                                                class="w-full text-left border rounded px-3 py-2 text-xs hover:bg-slate-50"
                                                @click="loadEasyViewFromHistory(entry)"
                                            >
                                                <p class="font-semibold">{{ entry.label }}</p>
                                                <p class="text-[11px] text-slate-500">{{ entry.start_ip }} ‚Äì {{ entry.end_ip }}</p>
                                            </button>
                                        </div>
                                    </div>
                                </aside>
                                <section class="bg-white border rounded-lg p-4 shadow space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-semibold">Temporary grid</p>
                                            <p class="text-xs text-slate-500" v-if="easyViewRangeSummary">
                                                Viewing: {{ easyViewRangeSummary.total }} addresses ‚Ä¢ {{ easyViewRangeSummary.label }}
                                            </p>
                                            <p class="text-xs text-slate-500" v-else>
                                                Load a range to display the grid.
                                            </p>
                                        </div>
                                    </div>
                                    <div v-if="planner.easyView.loading" class="text-xs text-slate-500">Loading temporary range‚Ä¶</div>
                                    <div v-else-if="planner.easyView.detailCells.length" class="border rounded bg-slate-50 p-3">
                                        <div
                                            v-for="row in easyViewDetailRows"
                                            :key="`easy-${row.key}`"
                                            class="space-y-0"
                                            :style="plannerRowStyle(row)"
                                        >
                                            <div
                                                v-if="row.segmentLabel && row.showLabel"
                                                class="text-[11px] text-slate-400"
                                            >
                                                {{ row.segmentLabel }}
                                            </div>
                                            <div class="flex flex-wrap gap-[2px]">
                                                <span
                                                    v-for="n in row.leading"
                                                    :key="`easy-lead-${row.key}-${n}`"
                                                    class="inline-block"
                                                    style="width:12px;height:12px;visibility:hidden"
                                                ></span>
                                                <span
                                                    v-for="cell in row.cells"
                                                    :key="`easy-cell-${cell.index}`"
                                                    class="inline-block cursor-pointer"
                                                    :style="plannerCellStyle(cell, 'easy')"
                                                    @mouseenter="handlePlannerHover(cell, $event, 'easy')"
                                                    @mousemove="handlePlannerHoverMove($event)"
                                                    @mouseleave="clearPlannerHover"
                                                    @click="selectPlannerCell(cell, 'easy')"
                                                    @dblclick="emphasizePlannerCell(cell, 'easy')"
                                                ></span>
                                                <span
                                                    v-for="n in row.trailing"
                                                    :key="`easy-trail-${row.key}-${n}`"
                                                    class="inline-block"
                                                    style="width:12px;height:12px;visibility:hidden"
                                                ></span>
                                            </div>
                                        </div>
                                    </div>
                                    <p v-else class="text-xs text-slate-400 border rounded bg-slate-50 p-3">No temporary grid loaded.</p>
                                    <div class="bg-slate-50 border rounded p-3 mt-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <p class="font-semibold text-xs">Cell Detail</p>
                                            <button v-if="planner.selectedCell" @click="clearSelectedCell" class="text-[10px] text-slate-500 underline">Clear</button>
                                        </div>
                                        <div v-if="planner.selectedCell" class="space-y-2 text-xs">
                                            <div class="border-b pb-2">
                                                <p class="text-slate-500">Address</p>
                                                <div class="flex items-center gap-2">
                                                    <p class="font-mono text-sm font-semibold">{{ planner.selectedCell.address }}</p>
                                                    <button @click="copyToClipboard(planner.selectedCell.address)" class="text-[11px] px-2 py-1 border rounded text-slate-600 hover:bg-slate-100">Copy</button>
                                                </div>
                                            </div>
                                            <div class="border-b pb-2">
                                                <p class="text-slate-500">Status</p>
                                                <p class="font-semibold">{{ planner.selectedCell.state }}</p>
                                            </div>
                                            <div v-if="planner.selectedCell.flows && planner.selectedCell.flows.length" class="space-y-1">
                                                <p class="text-slate-500 font-semibold">Flows ({{ planner.selectedCell.flows.length }})</p>
                                                <div v-for="flow in planner.selectedCell.flows" :key="flow.flow_id" class="border rounded p-2 bg-white">
                                                    <div class="flex items-start justify-between gap-2">
                                                        <div class="flex-1 min-w-0">
                                                            <p class="font-semibold text-[11px] truncate">{{ flow.display_name || flow.flow_id }}</p>
                                                            <p class="text-[10px] text-slate-500">{{ flow.flow_status }} / {{ flow.availability }}</p>
                                                            <p v-if="flow.nmos_node_label" class="text-[10px] text-slate-400 truncate">{{ flow.nmos_node_label }}</p>
                                                        </div>
                                                        <button @click="showFlow(flow.flow_id)" class="text-xs text-slate-600 underline whitespace-nowrap">Details</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <p v-else class="text-slate-400 text-[11px]">No flows using this address.</p>
                                        </div>
                                        <p v-else class="text-slate-400 text-[11px]">Click a cell to see details. Hover for quick info.</p>
                                    </div>
                                    <div
                                        v-if="planner.hoverTooltip.visible && planner.hoverInfo"
                                        class="fixed z-50 pointer-events-none bg-white/95 border border-slate-300 rounded shadow-lg text-xs text-slate-700 w-56"
                                        :style="{ top: planner.hoverTooltip.y + 'px', left: planner.hoverTooltip.x + 'px' }"
                                    >
                                        <div class="px-3 py-2 border-b">
                                            <p class="font-semibold">Address</p>
                                            <p class="font-mono text-[11px]">{{ planner.hoverInfo.address }}</p>
                                        </div>
                                        <div class="px-3 py-2 border-b">
                                            <p class="font-semibold">Status</p>
                                            <p>{{ planner.hoverInfo.state }}</p>
                                        </div>
                                        <div class="px-3 py-2" v-if="planner.hoverInfo.flows && planner.hoverInfo.flows.length">
                                            <p class="font-semibold mb-1">Flows</p>
                                            <p
                                                v-for="flow in planner.hoverInfo.flows"
                                                :key="flow.flow_id"
                                                class="truncate"
                                            >
                                                {{ flow.display_name || flow.flow_id }}
                                            </p>
                                        </div>
                                        <div class="px-3 py-2 text-slate-400" v-else>No flow information.</div>
                                    </div>
                                </section>
                            </div>
                        </div>
                        <div v-else-if="planner.tab==='backup'" class="space-y-4">
                            <div class="bg-white border rounded-lg p-4 shadow space-y-3">
                                <h3 class="font-semibold text-sm">Export Planner Data</h3>
                                <p class="text-xs text-slate-500">Download the entire folder/view structure as a JSON file.</p>
                                <button
                                    class="px-4 py-2 rounded bg-slate-900 text-white text-sm disabled:opacity-60"
                                    :disabled="planner.backup.exporting"
                                    @click="exportPlannerBackup"
                                >
                                    {{ planner.backup.exporting ? 'Exporting...' : 'Download JSON' }}
                                </button>
                            </div>
                            <div class="bg-white border rounded-lg p-4 shadow space-y-3">
                                <h3 class="font-semibold text-sm text-red-600">Import Planner Data</h3>
                                <p class="text-xs text-slate-500">Replacing data will remove all existing folders/views. Use with caution.</p>
                                <div class="flex flex-wrap items-center gap-3 text-xs">
                                    <label class="px-3 py-2 border rounded bg-white cursor-pointer">
                                        Choose JSON
                                        <input type="file" class="hidden" accept="application/json" @change="handlePlannerBackupFile" ref="plannerBackupInput" />
                                    </label>
                                    <span class="text-slate-500">
                                        {{ planner.backup.file ? planner.backup.file.name : 'No file selected' }}
                                    </span>
                                </div>
                                <button
                                    class="px-4 py-2 rounded bg-emerald-600 text-white text-sm disabled:opacity-60"
                                    :disabled="planner.backup.importing || !planner.backup.file"
                                    @click="importPlannerBackup"
                                >
                                    {{ planner.backup.importing ? 'Importing...' : 'Import JSON' }}
                                </button>
                                <p class="text-xs text-slate-500">Only administrator accounts can run this operation.</p>
                            </div>
                        </div>
            </template>

            <template v-else-if="currentView==='flows'">
                <section class="bg-white rounded shadow-lg p-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-lg">Flows / „Éï„É≠„Éº‰∏ÄË¶ß</h2>
                        <div class="flex items-center gap-2 text-sm">
                            <label>limit <input type="number" min="1" max="500" class="w-20 border rounded px-2 py-1 bg-white" v-model.number="filters.limit" /></label>
                            <label>offset <input type="number" min="0" class="w-20 border rounded px-2 py-1 bg-white" v-model.number="filters.offset" /></label>
                            <label class="flex items-center gap-1">
                                sort
                                <select class="border rounded px-2 py-1" v-model="filters.sort_by">
                                    <option v-for="option in sortFields" :key="option.value" :value="option.value">
                                        {{ option.label }}
                                    </option>
                                </select>
                            </label>
                            <label class="flex items-center gap-1">
                                order
                                <select class="border rounded px-2 py-1" v-model="filters.sort_order">
                                    <option value="desc">Descending</option>
                                    <option value="asc">Ascending</option>
                                </select>
                            </label>
                            <button class="px-3 py-1 bg-slate-900 text-white rounded" @click="refreshFlows">Refresh</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-3 text-xs text-slate-600">
                        <div class="flex items-center gap-2">
                            <span>Page / „Éö„Éº„Ç∏</span>
                            <input type="number" min="1" class="w-20 border rounded px-2 py-1 bg-white" v-model="pageInput" />
                            <button class="px-3 py-1 rounded text-white bg-slate-900 hover:bg-slate-800 transition" @click="applyPageInput">Go / ÁßªÂãï</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="px-3 py-1 rounded transition"
                                :class="canGoPrevious ? 'bg-slate-900 text-white hover:bg-slate-800 border border-slate-900' : 'bg-slate-100 text-slate-400 border border-slate-200 cursor-not-allowed'"
                                @click="prevPage"
                                :disabled="!canGoPrevious">
                                Previous / Ââç„Å∏
                            </button>
                            <button class="px-3 py-1 rounded transition"
                                :class="canGoNext ? 'bg-slate-900 text-white hover:bg-slate-800 border border-slate-900' : 'bg-slate-100 text-slate-400 border border-slate-200 cursor-not-allowed'"
                                @click="nextPage"
                                :disabled="!canGoNext">
                                Next / Ê¨°„Å∏
                            </button>
                        </div>
                        <span>Current page: {{ currentPageNumber }}</span>
                        <span>Showing {{ filters.offset + 1 }} - {{ filters.offset + flows.length }}</span>
                    </div>
                    <div class="overflow-auto">
                        <table class="w-full text-sm border border-slate-200">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="px-3 py-2 text-left">Display Name</th>
                                    <th class="px-3 py-2 text-left">flow_id</th>
                                    <th class="px-3 py-2 text-left">status</th>
                                    <th class="px-3 py-2 text-left">Source A</th>
                                    <th class="px-3 py-2 text-left">Multicast A</th>
                                    <th class="px-3 py-2 text-left">Source B</th>
                                    <th class="px-3 py-2 text-left">Multicast B</th>
                                    <th class="px-3 py-2 text-left">Updated At</th>
                                    <th class="px-3 py-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="flow in flows" :key="flow.flow_id" class="border-t hover:bg-slate-50">
                                    <td class="px-3 py-2">
                                        <div class="font-semibold flex items-center gap-1">
                                            <span>{{ flow.display_name || '-' }}</span>
                                            <span v-if="flow.locked" class="text-slate-500 text-base leading-none">‚öø</span>
                                        </div>
                                        <div v-if="flow.nmos_node_label" class="text-xs text-slate-500 mt-0.5">{{ flow.nmos_node_label }}</div>
                                    </td>
                                    <td class="px-3 py-2 text-xs">
                                        <div class="flex items-center gap-2">
                                            <span class="font-mono break-all">{{ flow.flow_id }}</span>
                                            <button
                                                class="text-[11px] px-2 py-1 border rounded text-slate-600 hover:bg-slate-100"
                                                @click="copyToClipboard(flow.flow_id)"
                                            >
                                                Copy
                                            </button>
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 text-xs">{{ flow.flow_status }}/{{ flow.availability }}</td>
                                    <td class="px-3 py-2 text-xs font-mono">{{ flow.source_addr_a }}:{{ flow.source_port_a }}</td>
                                    <td class="px-3 py-2 text-xs font-mono">{{ flow.multicast_addr_a }}:{{ flow.group_port_a }}</td>
                                    <td class="px-3 py-2 text-xs font-mono">{{ flow.source_addr_b }}:{{ flow.source_port_b }}</td>
                                    <td class="px-3 py-2 text-xs font-mono">{{ flow.multicast_addr_b }}:{{ flow.group_port_b }}</td>
                                    <td class="px-3 py-2 text-xs">{{ flow.updated_at }}</td>
                                    <td class="px-3 py-2 text-xs">
                                        <div class="flex flex-col gap-1">
                                            <button class="text-slate-600 underline" @click="showFlow(flow.flow_id)">Details</button>
                                            <button class="text-emerald-600 underline" @click="loadFlowForEdit(flow.flow_id)">Edit</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="flows.length === 0">
                                    <td colspan="9" class="text-center py-4 text-slate-500">No flows found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='search'">
                <div class="space-y-6">
                    <section class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div>
                            <h2 class="font-semibold text-lg">Quick Search / Á∞°ÊòìÊ§úÁ¥¢</h2>
                            <p class="text-xs text-slate-500">Search all text fields with partial match keywords.</p>
                        </div>
                        <div class="flex flex-col gap-3 md:flex-row md:items-end md:gap-4 text-sm">
                            <label class="flex-1 flex flex-col gap-1 text-slate-600">
                                Keyword / „Ç≠„Éº„ÉØ„Éº„Éâ
                                <input type="text" class="border rounded px-3 py-2" v-model="quickSearch.term" placeholder="studio / 239.10.0.1" />
                            </label>
                            <label class="flex flex-col gap-1 text-slate-600">
                                Limit
                                <input type="number" min="1" max="200" class="border rounded px-3 py-2" v-model.number="quickSearch.limit" />
                            </label>
                            <button class="bg-slate-900 text-white rounded px-4 py-2 md:self-end" @click="runQuickSearch">
                                Search
                            </button>
                        </div>
                    </section>

                    <section class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between">
                            <div>
                                <h2 class="font-semibold text-lg">Advanced Search / Ë©≥Á¥∞Ê§úÁ¥¢</h2>
                                <p class="text-xs text-slate-500">Enter conditions per field; numeric and datetime values support ranges.</p>
                            </div>
                            <button
                                class="text-xs text-slate-600 border rounded px-3 py-1 self-start"
                                @click="toggleAdvancedCollapse"
                            >
                                {{ advancedCollapsed ? '‚ñº Expand / Â±ïÈñã' : '‚ñ≤ Collapse / Á∏ÆÂ∞è' }}
                            </button>
                        </div>
                        <div class="grid gap-3" v-show="!advancedCollapsed">
                            <div class="flex flex-col md:flex-row md:items-end gap-3 text-sm text-slate-600">
                                <label class="flex flex-col gap-1 text-slate-600 w-full md:w-48 lg:w-40">
                                    Limit
                                    <input
                                        type="number"
                                        min="1"
                                        max="200"
                                        class="border rounded px-3 py-2"
                                        v-model.number="advancedSearch.limit"
                                    />
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-500">
                                <label>Display Name
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.display_name" placeholder="ex. Studio" />
                                </label>
                                <label>Flow ID
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.flow_id" placeholder="UUID" />
                                </label>
                                <label>NMOS Node ID
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.nmos_node_id" placeholder="UUID" />
                                </label>
                                <label>Source Address A
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.source_addr_a" />
                                </label>
                                <label>Source Address B
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.source_addr_b" />
                                </label>
                                <label>Multicast Address A
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.multicast_addr_a" />
                                </label>
                                <label>Multicast Address B
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.multicast_addr_b" />
                                </label>
                                <label>Transport Protocol
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.transport_protocol" />
                                </label>
                                <label>Label / Alias
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.alias1" placeholder="Alias contains" />
                                </label>
                                <label>Status
                                    <select class="w-full border rounded px-3 py-2" v-model="advancedSearch.flow_status">
                                        <option value="">Any / ÊåáÂÆö„Å™„Åó</option>
                                        <option v-for="status in flowStatusOptions" :key="status" :value="status">
                                            {{ status }}
                                        </option>
                                    </select>
                                </label>
                                <label>Availability
                                    <select class="w-full border rounded px-3 py-2" v-model="advancedSearch.availability">
                                        <option value="">Any / ÊåáÂÆö„Å™„Åó</option>
                                        <option v-for="state in availabilityOptions" :key="state" :value="state">
                                            {{ state }}
                                        </option>
                                    </select>
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-500">
                                <div>
                                    <p class="font-semibold mb-2 text-slate-600">Port Range / „Éù„Éº„ÉàÁØÑÂõ≤</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label>Src A Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.source_port_a_min" />
                                        </label>
                                        <label>Src A Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.source_port_a_max" />
                                        </label>
                                        <label>Src B Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.source_port_b_min" />
                                        </label>
                                        <label>Src B Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.source_port_b_max" />
                                        </label>
                                        <label>Group A Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.group_port_a_min" />
                                        </label>
                                        <label>Group A Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.group_port_a_max" />
                                        </label>
                                        <label>Group B Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.group_port_b_min" />
                                        </label>
                                        <label>Group B Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.group_port_b_max" />
                                        </label>
                                        <label>IS-04 Port Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.nmos_is04_port_min" />
                                        </label>
                                        <label>IS-04 Port Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.nmos_is04_port_max" />
                                        </label>
                                        <label>IS-05 Port Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.nmos_is05_port_min" />
                                        </label>
                                        <label>IS-05 Port Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.nmos_is05_port_max" />
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <p class="font-semibold mb-1 text-slate-600">Date Range</p>
                                    <p class="text-[11px] text-slate-500 mb-2">Format: YYYY-MM-DDTHH:MM (24h)</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label>Updated From
                                            <input type="datetime-local" lang="en-CA" step="1" placeholder="YYYY-MM-DDTHH:MM" class="w-full border rounded px-2 py-1" v-model="advancedSearch.updated_at_min" />
                                        </label>
                                        <label>Updated To
                                            <input type="datetime-local" lang="en-CA" step="1" placeholder="YYYY-MM-DDTHH:MM" class="w-full border rounded px-2 py-1" v-model="advancedSearch.updated_at_max" />
                                        </label>
                                        <label>Created From
                                            <input type="datetime-local" lang="en-CA" step="1" placeholder="YYYY-MM-DDTHH:MM" class="w-full border rounded px-2 py-1" v-model="advancedSearch.created_at_min" />
                                        </label>
                                        <label>Created To
                                            <input type="datetime-local" lang="en-CA" step="1" placeholder="YYYY-MM-DDTHH:MM" class="w-full border rounded px-2 py-1" v-model="advancedSearch.created_at_max" />
                                        </label>
                                    </div>
                                    <div class="mt-3 flex items-center gap-3">
                                        <label class="flex items-center gap-2 text-xs text-slate-600">
                                            <input type="checkbox" v-model="advancedSearch.include_unused" />
                                            Include unused / Ë´ñÁêÜÂâäÈô§„ÇíÂê´„ÇÄ
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button class="bg-slate-900 text-white rounded px-4 py-2 text-sm" @click="runAdvancedSearch">Advanced Search</button>
                                <button class="px-4 py-2 border rounded text-sm" @click="resetAdvancedSearch">Reset</button>
                            </div>
                        </div>
                        <p v-if="advancedCollapsed" class="text-xs text-slate-500">Advanced search form is hidden. Expand to edit conditions.</p>
                    </section>
                </div>
                <section class="bg-white rounded shadow-lg p-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">Results / Ê§úÁ¥¢ÁµêÊûú</h3>
                            <p class="text-xs text-slate-500">Mode: {{ searchMode || 'not started' }}</p>
                        </div>
                        <button class="text-sm text-slate-600 underline" @click="refreshFlows">Reload latest flows</button>
                    </div>
                    <div class="overflow-auto">
                        <table class="w-full text-sm border border-slate-200 min-w-[760px]">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="px-3 py-2 text-left">Display Name</th>
                                    <th class="px-3 py-2 text-left">Flow ID</th>
                                    <th class="px-3 py-2 text-left">Status</th>
                                    <th class="px-3 py-2 text-left">Source A</th>
                                    <th class="px-3 py-2 text-left">Multicast A</th>
                                    <th class="px-3 py-2 text-left">Updated</th>
                                    <th class="px-3 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="flow in searchResults" :key="flow.flow_id" class="border-t hover:bg-slate-50">
                                    <td class="px-3 py-2">
                                        <div class="font-semibold flex items-center gap-1">
                                            <span>{{ flow.display_name || '-' }}</span>
                                            <span v-if="flow.locked" class="text-slate-500 text-base leading-none">‚öø</span>
                                        </div>
                                        <div v-if="flow.nmos_node_label" class="text-xs text-slate-500 mt-0.5">{{ flow.nmos_node_label }}</div>
                                    </td>
                                    <td class="px-3 py-2 text-xs">
                                        <div class="flex items-center gap-2">
                                            <span class="font-mono break-all">{{ flow.flow_id }}</span>
                                            <button
                                                class="text-[11px] px-2 py-1 border rounded text-slate-600 hover:bg-slate-100"
                                                @click="copyToClipboard(flow.flow_id)"
                                            >
                                                Copy
                                            </button>
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 text-xs">{{ flow.flow_status }} / {{ flow.availability }}</td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.source_addr_a }}:{{ flow.source_port_a }}</td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.multicast_addr_a }}:{{ flow.group_port_a }}</td>
                                    <td class="px-3 py-2 text-xs">{{ flow.updated_at }}</td>
                                    <td class="px-3 py-2 text-xs">
                                        <div class="flex flex-col gap-1">
                                            <button class="text-slate-600 underline" @click="showFlow(flow.flow_id)">Details</button>
                                            <button class="text-emerald-600 underline" @click="loadFlowForEdit(flow.flow_id)">Edit</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="searchResults.length === 0">
                                    <td colspan="7" class="text-center py-4 text-slate-500">No results / Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='newFlow'">
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="font-semibold text-lg">
                                {{ editingFlowId ? 'Flow Update / Edit Flow' : 'Create Flow (Manual)' }}
                            </h2>
                            <p v-if="editingFlowId" class="text-xs text-slate-500">Editing: {{ editingFlowId }}</p>
                        </div>
                        <div class="flex flex-col gap-2 items-end">
                            <div class="flex items-center gap-2" v-if="editingFlowId">
                                <button
                                    class="px-3 py-1 text-xs rounded border flex items-center gap-1"
                                    :class="newFlow.locked ? 'border-red-300 text-red-600 bg-red-50' : 'border-emerald-300 text-emerald-600 bg-emerald-50'"
                                    :disabled="!lockToggleAllowed || lockToggleLoading"
                                    @click="toggleFlowLock"
                                >
                                    <span v-if="newFlow.locked" class="flex items-center gap-1">
                                        <span class="text-slate-500 text-base leading-none">‚öø</span>
                                        <span>Locked</span>
                                    </span>
                                    <span v-else>Unlocked</span>
                                </button>
                                <span v-if="!lockToggleAllowed" class="text-[11px] text-slate-500">insufficient role</span>
                                <button
                                    class="px-3 py-1 border rounded text-xs"
                                    :disabled="nmos.checking"
                                    @click="checkNmos(editingFlowId)"
                                >
                                    NMOS Check
                                </button>
                                <button
                                    class="px-3 py-1 text-xs rounded border"
                                    :class="canApplyNmos(editingFlowId) ? 'border-emerald-500 text-emerald-600' : 'text-slate-400 border-slate-200 cursor-not-allowed'"
                                    :disabled="!canApplyNmos(editingFlowId) || nmos.applying"
                                    @click="openNmosApplyDialog(editingFlowId)"
                                >
                                    NMOS Sync
                                </button>
                                <span v-if="canApplyNmos(editingFlowId)" class="text-[11px] text-red-600">
                                    Diff / Â∑ÆÂàÜ: {{ nmosDiffSummary(editingFlowId) }}
                                </span>
                            </div>
                            <div class="flex gap-3">
                                <button class="px-3 py-2 border rounded text-sm" @click="resetFlowForm">Reset</button>
                                <button
                                    class="px-4 py-2 bg-emerald-600 text-white rounded text-sm disabled:opacity-50"
                                    @click="submitFlow"
                                    :disabled="editingFlowId && newFlow.locked"
                                >
                                    {{ editingFlowId ? 'Update' : 'Create' }}
                                </button>
                                <button
                                    v-if="editingFlowId"
                                    class="px-4 py-2 bg-red-500 text-white rounded text-sm disabled:opacity-50"
                                    :disabled="newFlow.locked"
                                    @click="deleteFlow(editingFlowId)"
                                >
                                    Delete Flow
                                </button>
                            </div>
                        </div>
                    </div>
                    <p v-if="newFlow.locked" class="text-xs text-red-600">
                        This flow is locked. Field editing and deletion are disabled, but NMOS Check is available (NMOS Sync requires unlocking). / „Åì„ÅÆ„Éï„É≠„Éº„ÅØ„É≠„ÉÉ„ÇØ‰∏≠„Åß„Åô„ÄÇ„Éï„Ç£„Éº„É´„ÉâÁ∑®ÈõÜ„ÇÑÂâäÈô§„ÅØ„Åß„Åç„Åæ„Åõ„Çì„Åå„ÄÅNMOS Check „ÅØÂÆüË°å„Åß„Åç„Åæ„ÅôÔºàNMOS Sync „ÅØËß£Èô§Âæå„Å´ÂèØËÉΩÔºâ„ÄÇ
                    </p>
                    <p v-if="nmos.error && nmos.targetFlowId === editingFlowId" class="text-xs text-red-600">{{ nmos.error }}</p>
                    <fieldset :disabled="newFlow.locked" class="space-y-4 border-0 p-0 m-0">
                        <div v-for="group in fieldGroups" :key="group.title" class="border rounded p-4">
                            <h3 class="font-semibold text-base mb-3">{{ group.title }}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label v-for="field in group.fields" :key="field.key" class="text-xs text-slate-500 space-y-1">
                                    {{ field.label }}
                                    <template v-if="field.type === 'textarea'">
                                        <textarea
                                            :class="['w-full border rounded px-3 py-2', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            rows="field.rows || 3"
                                            v-model="newFlow[field.key]"
                                        ></textarea>
                                    </template>
                                    <template v-else-if="field.type === 'select'">
                                        <select
                                            :class="['w-full border rounded px-3 py-2', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            v-model="newFlow[field.key]"
                                        >
                                            <option v-for="option in field.options" :key="option" :value="option">{{ option }}</option>
                                        </select>
                                    </template>
                                    <template v-else-if="field.key === 'flow_id'">
                                        <input
                                            type="text"
                                            :class="['w-full border rounded px-3 py-2 disabled:bg-slate-100 disabled:text-slate-500', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            v-model="newFlow[field.key]"
                                            :disabled="newFlow.data_source === 'manual'"
                                            placeholder="Auto assigned / NMOS Flow ID"
                                        />
                                        <span class="text-[10px] text-slate-500 block">
                                            Auto-generated for manual entries; editable only via NMOS/RDS imports.
                                        </span>
                                    </template>
                                    <template v-else>
                                        <input
                                            v-if="field.type === 'number'"
                                            type="number"
                                            :class="['w-full border rounded px-3 py-2', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            v-model.number="newFlow[field.key]"
                                        />
                                        <input
                                            v-else
                                            type="text"
                                            :class="['w-full border rounded px-3 py-2', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            v-model="newFlow[field.key]"
                                        />
                                    </template>
                                </label>
                            </div>
                        </div>
                    </fieldset>
                    <p class="text-xs text-slate-500">Designed for future NMOS / RDS auto-fill wizards.</p>
                </section>
            </template>

            <template v-else-if="currentView==='wizard'">
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="font-semibold text-lg">NMOS Import Wizard</h2>
                            <p class="text-xs text-slate-500">Fetch flows from an NMOS IS-04 Node endpoint.</p>
                        </div>
                        <span class="text-xs text-slate-400">
                            {{ wizard.node ? 'Node: ' + (wizard.node.label || wizard.node.id || '-') : '' }}
                        </span>
                    </div>
                    <div class="border-l-2 border-slate-300 pl-3 py-1 text-xs text-slate-600">
                        <p class="mb-1"><strong>Required:</strong> IS-04 Base URL, IS-04 Version, IS-05 Base URL, IS-05 Version / <strong>ÂøÖÈ†à:</strong> IS-04 Base URL, IS-04 Version, IS-05 Base URL, IS-05 Version</p>
                        <p class="mb-1"><strong>Optional:</strong> Use RDS to auto-detect IS-04 from NMOS nodes. / <strong>„Ç™„Éó„Ç∑„Éß„É≥:</strong> RDS„Çí‰ΩøÁî®„Åó„Å¶NMOS„Éé„Éº„Éâ„Åã„ÇâIS-04„ÇíËá™ÂãïÊ§úÂá∫„ÄÇ</p>
                    </div>

                    <!-- RDS Section -->
                    <div class="bg-slate-50 border border-slate-200 rounded p-3 space-y-3">
                        <label class="flex items-center gap-2 text-sm font-medium text-slate-700">
                            <input type="checkbox" v-model="wizard.useRDS" class="w-4 h-4" />
                            Select from RDS / RDS„Åã„ÇâÈÅ∏Êäû
                        </label>

                        <div v-if="wizard.useRDS" class="space-y-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <label class="text-slate-600">
                                    RDS Base URL (up to /x-nmos/)
                                    <input type="text" class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.rdsBaseUrl" placeholder="http://example:8080/x-nmos/" />
                                </label>
                                <label class="text-slate-600">
                                    RDS Version
                                    <select class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.rdsVersion">
                                        <option v-for="version in wizard.rdsVersions" :key="version" :value="version">{{ version }}</option>
                                    </select>
                                </label>
                            </div>
                            <button type="button" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" @click="fetchRDSNodes" :disabled="wizard.fetchingRDS">
                                {{ wizard.fetchingRDS ? 'Fetching...' : 'Fetch RDS Nodes' }}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 text-sm">
                        <div class="flex gap-2 items-end">
                            <label class="text-slate-600 flex-1">
                                IS-04 Base URL (up to /x-nmos/) <span class="text-red-500">*</span>
                                <input type="text" class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.is04BaseUrl" placeholder="http://example:8080/x-nmos/" />
                            </label>
                            <span class="text-lg leading-none mb-2">‚áí</span>
                            <div class="text-slate-600">
                                <div class="mb-1 text-xs opacity-0">placeholder</div>
                                <button type="button" class="px-4 py-2 text-xs border rounded whitespace-pre-line leading-tight hover:bg-slate-100 auto-detect-blink" @click="detectIS05" :disabled="wizard.detectingIS05">{{ wizard.detectingIS05 ? 'Detecting...' : 'IS-05\nAuto Detect' }}</button>
                            </div>
                            <span class="text-lg leading-none mb-2">‚áí</span>
                            <label class="text-slate-600 flex-1">
                                IS-05 Base URL (up to /x-nmos/) <span class="text-red-500">*</span>
                                <input type="text" class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.is05BaseUrl" placeholder="http://example:8080/x-nmos/" />
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <label class="text-slate-600">
                            IS-04 Version <span class="text-red-500">*</span>
                            <select class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.is04Version">
                                <option v-for="version in wizard.is04Versions" :key="version" :value="version">
                                    {{ version }}
                                </option>
                            </select>
                        </label>
                        <label class="text-slate-600">
                            IS-05 Version <span class="text-red-500">*</span>
                            <select class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.is05Version">
                                <option v-for="version in wizard.is05Versions" :key="version" :value="version">
                                    {{ version }}
                                </option>
                            </select>
                        </label>
                        <div class="flex items-end md:col-span-2">
                            <button class="px-4 py-2 bg-slate-900 text-white rounded w-full" @click="fetchNmosFlows" :disabled="wizard.loading">
                                {{ wizard.loading ? 'Loading...' : 'Fetch Flows' }}
                            </button>
                        </div>
                    </div>
                    <p v-if="wizard.error" class="text-sm text-red-600">{{ wizard.error }}</p>
                    <div v-if="wizard.node" class="text-xs text-slate-500 bg-slate-100 rounded p-3">
                        <p>Node ID: <span class="font-mono">{{ wizard.node.id }}</span></p>
                        <p v-if="wizard.node.description">{{ wizard.node.description }}</p>
                    </div>
                </section>
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">Discovered Flows</h3>
                            <p class="text-xs text-slate-500">Select flows to import into MMAM.</p>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-slate-600">
                            <span>Selected: {{ wizardSelectedCount }}</span>
                            <button
                                class="px-3 py-1 bg-emerald-600 text-white rounded"
                                :disabled="wizardSelectedCount === 0 || wizard.importing"
                                @click="importSelectedFlows"
                            >
                                {{ wizard.importing ? 'Importing...' : 'Import Selected' }}
                            </button>
                        </div>
                    </div>
                    <div class="overflow-auto">
                        <table class="w-full text-sm border border-slate-200">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="px-3 py-2 text-center">
                                        <label class="inline-flex items-center justify-center">
                                            <input
                                                type="checkbox"
                                                :checked="wizardAllSelected"
                                                :indeterminate="wizardIndeterminate"
                                                @change="toggleWizardSelectAll($event.target.checked)"
                                            />
                                            <span class="sr-only">Select all</span>
                                        </label>
                                    </th>
                                    <th class="px-3 py-2 text-left">Label</th>
                                    <th class="px-3 py-2 text-left">Flow ID</th>
                                    <th class="px-3 py-2 text-left">Sender ID</th>
                                    <th class="px-3 py-2 text-left">Device ID</th>
                                    <th class="px-3 py-2 text-left">Format</th>
                                    <th class="px-3 py-2 text-left">Transport</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="flow in wizard.flows" :key="flow.nmos_flow_id" class="border-t hover:bg-slate-50">
                                    <td class="px-3 py-2 text-center">
                                        <input
                                            type="checkbox"
                                            :checked="isWizardFlowSelected(flow.nmos_flow_id)"
                                            @change="toggleWizardSelection(flow.nmos_flow_id, $event.target.checked)"
                                        />
                                    </td>
                                    <td class="px-3 py-2">
                                        <p class="font-semibold">{{ flow.label }}</p>
                                        <p class="text-xs text-slate-500">{{ flow.description }}</p>
                                    </td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.nmos_flow_id }}</td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.nmos_sender_id || '-' }}</td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.nmos_device_id || '-' }}</td>
                                    <td class="px-3 py-2 text-xs">{{ flow.format || '-' }}</td>
                                    <td class="px-3 py-2 text-xs">{{ flow.sender_transport || '-' }}</td>
                                </tr>
                                <tr v-if="wizard.flows.length === 0">
                                    <td colspan="7" class="text-center py-4 text-slate-500">
                                        {{ wizard.loading ? 'Fetching flows...' : 'No flows loaded yet.' }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='checker'">
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex flex-wrap gap-3 text-sm border-b border-slate-200 pb-2">
                        <button
                            v-for="tab in checkerTabs"
                            :key="tab.key"
                            class="px-4 py-2 transition-colors font-medium"
                            :class="currentCheckerTab===tab.key
                                ? 'text-slate-900 border-b-2 border-slate-900'
                                : 'text-slate-500 border-b-2 border-transparent hover:text-slate-700'"
                            @click="setCheckerTab(tab.key)"
                        >
                            {{ tab.label }}
                        </button>
                    </div>
                    <div v-if="currentCheckerTab==='collisions'" class="space-y-4">
                        <div class="flex flex-col md:flex-row md:items-center gap-3">
                            <div>
                                <h2 class="font-semibold text-lg">Collision Check</h2>
                                <p class="text-xs text-slate-500">
                                    Find duplicate multicast destinations across flows. Only logged-in editors/admins can run this check.
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    class="px-4 py-2 bg-slate-900 text-white rounded text-sm disabled:opacity-50"
                                    @click="runCollisionCheck"
                                    :disabled="checkerLoading"
                                >
                                    {{ checkerLoading ? 'Checking...' : 'Run Check' }}
                                </button>
                            </div>
                        </div>

                        <!-- Collision Automation Settings -->
                        <div class="border border-slate-300 rounded p-4 bg-slate-50 space-y-4">
                            <div class="flex items-center justify-between">
                                <h3 class="font-semibold text-base">Scheduled Automation / Ëá™ÂãïÂë®ÂõûË®≠ÂÆö</h3>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        class="w-4 h-4"
                                        v-model="collisionJob.enabled"
                                        @change="toggleCollisionJob"
                                        :disabled="!canEditAutomation"
                                    />
                                    <span class="text-sm font-medium">
                                        {{ collisionJob.enabled ? 'Enabled / ÊúâÂäπ' : 'Disabled / ÁÑ°Âäπ' }}
                                    </span>
                                </label>
                            </div>

                            <div v-if="collisionJob.enabled || editingCollisionSchedule" class="space-y-3">
                                <div>
                                    <label class="text-sm font-medium text-slate-700">Schedule Type / „Çπ„Ç±„Ç∏„É•„Éº„É´Á®ÆÈ°û</label>
                                    <div class="flex gap-4 mt-1">
                                        <label class="flex items-center gap-2">
                                            <input
                                                type="radio"
                                                value="interval"
                                                v-model="collisionJob.schedule_type"
                                            />
                                            <span class="text-sm">Interval / ÈñìÈöîÊåáÂÆö</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input
                                                type="radio"
                                                value="cron"
                                                v-model="collisionJob.schedule_type"
                                            />
                                            <span class="text-sm">Cron Expression / CronÂºè</span>
                                        </label>
                                    </div>
                                </div>

                                <div v-if="collisionJob.schedule_type === 'interval'" class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-slate-700">Run every / ÂÆüË°åÈñìÈöî:</label>
                                    <input
                                        type="number"
                                        min="1"
                                        class="w-20 border rounded px-2 py-1 text-sm"
                                        v-model.number="collisionIntervalValue"
                                    />
                                    <select
                                        class="border rounded px-2 py-1 text-sm"
                                        v-model="collisionIntervalUnit"
                                    >
                                        <option value="60">minutes / ÂàÜ</option>
                                        <option value="3600">hours / ÊôÇÈñì</option>
                                        <option value="86400">days / Êó•</option>
                                        <option value="604800">weeks / ÈÄ±</option>
                                    </select>
                                </div>

                                <div v-else class="space-y-2">
                                    <label class="text-sm font-medium text-slate-700">Cron Expression / CronÂºè</label>
                                    <input
                                        type="text"
                                        class="w-full border rounded px-3 py-2 text-sm font-mono"
                                        placeholder="0 0 * * *  (minute hour day month weekday)"
                                        v-model="collisionJob.schedule_value"
                                    />
                                    <div class="text-xs text-slate-500 space-y-1">
                                        <p>Examples / ‰æã:</p>
                                        <ul class="list-disc list-inside pl-2">
                                            <li><code class="bg-white px-1">0 0 * * *</code> - Every day at 00:00 / ÊØéÊó•0ÊôÇ</li>
                                            <li><code class="bg-white px-1">0 */6 * * *</code> - Every 6 hours / 6ÊôÇÈñì„Åî„Å®</li>
                                            <li><code class="bg-white px-1">0 9 * * 1</code> - Every Monday at 09:00 / ÊØéÈÄ±ÊúàÊõú9ÊôÇ</li>
                                        </ul>
                                    </div>
                                </div>

                                <div v-if="collisionJob.next_run_time" class="text-sm text-slate-600">
                                    <span class="font-medium">Next run / Ê¨°ÂõûÂÆüË°å‰∫àÂÆö:</span>
                                    <span class="ml-2">{{ collisionJob.next_run_time }}</span>
                                </div>

                                <div class="flex gap-2">
                                    <button
                                        class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:opacity-50"
                                        @click="saveCollisionSchedule"
                                        :disabled="!canEditAutomation"
                                    >
                                        Save Schedule / „Çπ„Ç±„Ç∏„É•„Éº„É´„Çí‰øùÂ≠ò
                                    </button>
                                    <button
                                        v-if="editingCollisionSchedule"
                                        class="px-4 py-2 bg-slate-300 text-slate-700 rounded text-sm hover:bg-slate-400"
                                        @click="cancelEditCollisionSchedule"
                                    >
                                        Cancel / „Ç≠„É£„É≥„Çª„É´
                                    </button>
                                </div>

                                <div v-if="collisionJob.last_run_at" class="border-t pt-3 mt-3 text-xs text-slate-500">
                                    <p><span class="font-medium">Last run / ÊúÄÁµÇÂÆüË°å:</span> {{ collisionJob.last_run_at }}</p>
                                    <p v-if="collisionJob.last_run_status">
                                        <span class="font-medium">Status / „Çπ„ÉÜ„Éº„Çø„Çπ:</span>
                                        <span :class="collisionJob.last_run_status === 'success' ? 'text-emerald-600' : 'text-red-600'">
                                            {{ collisionJob.last_run_status }}
                                        </span>
                                    </p>
                                    <p v-if="collisionJob.last_run_result && collisionJob.last_run_result.collision_count !== undefined">
                                        <span class="font-medium">Result / ÁµêÊûú:</span>
                                        {{ collisionJob.last_run_result.collision_count }} collisions detected
                                    </p>
                                </div>
                            </div>

                            <div v-else class="text-sm text-slate-500 text-center py-2">
                                Enable automation to configure schedule / Ëá™ÂãïÂÆüË°å„ÇíÊúâÂäπÂåñ„Åó„Å¶„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË®≠ÂÆö
                            </div>

                            <div v-if="!canEditAutomation" class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                <p class="text-sm text-yellow-800">
                                    ‚ö†Ô∏è Admin permission required to modify automation settings. / Ëá™ÂãïÂåñË®≠ÂÆö„ÅÆÂ§âÊõ¥„Å´„ÅØAdminÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                                </p>
                            </div>
                        </div>

                        <div v-if="checkerResults.collisions">
                            <p class="text-xs text-slate-500">Last executed: {{ checkerResults.collisions.fetchedAt }}</p>
                            <div v-for="group in checkerResults.collisions.results" :key="group.field" class="border rounded p-4 mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-semibold text-base">{{ group.label }}</h3>
                                    <span class="text-xs text-slate-500">
                                        Duplicates: {{ group.entries.length }}
                                    </span>
                                </div>
                                <div v-if="group.entries.length > 0" class="overflow-auto">
                                    <table class="w-full text-xs border border-slate-200">
                                        <thead class="bg-slate-100 text-slate-600">
                                            <tr>
                                                <th class="px-3 py-2 text-left">Value</th>
                                                <th class="px-3 py-2 text-left">Count</th>
                                                <th class="px-3 py-2 text-left">Flows</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="entry in group.entries" :key="entry.value" class="border-t">
                                                <td class="px-3 py-2 font-mono break-all">{{ entry.value }}</td>
                                                <td class="px-3 py-2">{{ entry.count }}</td>
                                                <td class="px-3 py-2 text-xs">
                                                    <ul class="space-y-1">
                                                        <li
                                                            v-for="flow in entry.flows"
                                                            :key="flow.flow_id"
                                                            class="border-b border-slate-200 pb-1 last:border-none last:pb-0"
                                                        >
                                                            <div class="font-mono text-[11px] break-all flex items-center gap-2">
                                                                <span>ID: {{ flow.flow_id }}</span>
                                                                <button
                                                                    class="text-[10px] px-2 py-0.5 border rounded text-slate-600 hover:bg-slate-100"
                                                                    @click="copyToClipboard(flow.flow_id)"
                                                                >
                                                                    Copy
                                                                </button>
                                                            </div>
                                                            <div class="text-[11px] text-slate-600">
                                                                Name: {{ flow.display_name || '-' }}
                                                            </div>
                                                            <div class="text-[11px] text-slate-500">
                                                                Node: {{ flow.nmos_node_label || '-' }}
                                                            </div>
                                                        </li>
                                                    </ul>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p v-else class="text-xs text-slate-500">No duplicates found.</p>
                            </div>
                        </div>
                        <p v-else class="text-xs text-slate-500">No check has been executed yet.</p>
                    </div>
                    <div v-else-if="currentCheckerTab==='nmos'" class="space-y-4">
                        <div class="flex flex-col md:flex-row md:items-center gap-3">
                            <div>
                                <h2 class="font-semibold text-lg">NMOS Check</h2>
                                <p class="text-xs text-slate-500">
                                    Fetch NMOS snapshots for all flows and list the ones whose database values differ.
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    class="px-4 py-2 bg-slate-900 text-white rounded text-sm disabled:opacity-50"
                                    @click="runNmosCheck"
                                    :disabled="checkerLoading"
                                >
                                    {{ checkerLoading ? 'Checking...' : 'Run NMOS Check' }}
                                </button>
                            </div>
                        </div>

                        <!-- NMOS Automation Settings -->
                        <div class="border border-slate-300 rounded p-4 bg-slate-50 space-y-4">
                            <div class="flex items-center justify-between">
                                <h3 class="font-semibold text-base">Scheduled Automation / Ëá™ÂãïÂë®ÂõûË®≠ÂÆö</h3>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        class="w-4 h-4"
                                        v-model="nmosJob.enabled"
                                        @change="toggleNmosJob"
                                        :disabled="!canEditAutomation"
                                    />
                                    <span class="text-sm font-medium">
                                        {{ nmosJob.enabled ? 'Enabled / ÊúâÂäπ' : 'Disabled / ÁÑ°Âäπ' }}
                                    </span>
                                </label>
                            </div>

                            <div v-if="nmosJob.enabled || editingNmosSchedule" class="space-y-3">
                                <div>
                                    <label class="text-sm font-medium text-slate-700">Schedule Type / „Çπ„Ç±„Ç∏„É•„Éº„É´Á®ÆÈ°û</label>
                                    <div class="flex gap-4 mt-1">
                                        <label class="flex items-center gap-2">
                                            <input
                                                type="radio"
                                                value="interval"
                                                v-model="nmosJob.schedule_type"
                                            />
                                            <span class="text-sm">Interval / ÈñìÈöîÊåáÂÆö</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input
                                                type="radio"
                                                value="cron"
                                                v-model="nmosJob.schedule_type"
                                            />
                                            <span class="text-sm">Cron Expression / CronÂºè</span>
                                        </label>
                                    </div>
                                </div>

                                <div v-if="nmosJob.schedule_type === 'interval'" class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-slate-700">Run every / ÂÆüË°åÈñìÈöî:</label>
                                    <input
                                        type="number"
                                        min="1"
                                        class="w-20 border rounded px-2 py-1 text-sm"
                                        v-model.number="nmosIntervalValue"
                                    />
                                    <select
                                        class="border rounded px-2 py-1 text-sm"
                                        v-model="nmosIntervalUnit"
                                    >
                                        <option value="60">minutes / ÂàÜ</option>
                                        <option value="3600">hours / ÊôÇÈñì</option>
                                        <option value="86400">days / Êó•</option>
                                        <option value="604800">weeks / ÈÄ±</option>
                                    </select>
                                </div>

                                <div v-else class="space-y-2">
                                    <label class="text-sm font-medium text-slate-700">Cron Expression / CronÂºè</label>
                                    <input
                                        type="text"
                                        class="w-full border rounded px-3 py-2 text-sm font-mono"
                                        placeholder="0 0 * * *  (minute hour day month weekday)"
                                        v-model="nmosJob.schedule_value"
                                    />
                                    <div class="text-xs text-slate-500 space-y-1">
                                        <p>Examples / ‰æã:</p>
                                        <ul class="list-disc list-inside pl-2">
                                            <li><code class="bg-white px-1">0 0 * * *</code> - Every day at 00:00 / ÊØéÊó•0ÊôÇ</li>
                                            <li><code class="bg-white px-1">0 */6 * * *</code> - Every 6 hours / 6ÊôÇÈñì„Åî„Å®</li>
                                            <li><code class="bg-white px-1">0 9 * * 1</code> - Every Monday at 09:00 / ÊØéÈÄ±ÊúàÊõú9ÊôÇ</li>
                                        </ul>
                                    </div>
                                </div>

                                <div v-if="nmosJob.next_run_time" class="text-sm text-slate-600">
                                    <span class="font-medium">Next run / Ê¨°ÂõûÂÆüË°å‰∫àÂÆö:</span>
                                    <span class="ml-2">{{ nmosJob.next_run_time }}</span>
                                </div>

                                <div class="flex gap-2">
                                    <button
                                        class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:opacity-50"
                                        @click="saveNmosSchedule"
                                        :disabled="!canEditAutomation"
                                    >
                                        Save Schedule / „Çπ„Ç±„Ç∏„É•„Éº„É´„Çí‰øùÂ≠ò
                                    </button>
                                    <button
                                        v-if="editingNmosSchedule"
                                        class="px-4 py-2 bg-slate-300 text-slate-700 rounded text-sm hover:bg-slate-400"
                                        @click="cancelEditNmosSchedule"
                                    >
                                        Cancel / „Ç≠„É£„É≥„Çª„É´
                                    </button>
                                </div>

                                <div v-if="nmosJob.last_run_at" class="border-t pt-3 mt-3 text-xs text-slate-500">
                                    <p><span class="font-medium">Last run / ÊúÄÁµÇÂÆüË°å:</span> {{ nmosJob.last_run_at }}</p>
                                    <p v-if="nmosJob.last_run_status">
                                        <span class="font-medium">Status / „Çπ„ÉÜ„Éº„Çø„Çπ:</span>
                                        <span :class="nmosJob.last_run_status === 'success' ? 'text-emerald-600' : 'text-red-600'">
                                            {{ nmosJob.last_run_status }}
                                        </span>
                                    </p>
                                    <p v-if="nmosJob.last_run_result && nmosJob.last_run_result.nmos_difference_count !== undefined">
                                        <span class="font-medium">Result / ÁµêÊûú:</span>
                                        {{ nmosJob.last_run_result.nmos_difference_count }} differences detected
                                    </p>
                                </div>
                            </div>

                            <div v-else class="text-sm text-slate-500 text-center py-2">
                                Enable automation to configure schedule / Ëá™ÂãïÂÆüË°å„ÇíÊúâÂäπÂåñ„Åó„Å¶„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË®≠ÂÆö
                            </div>

                            <div v-if="!canEditAutomation" class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                <p class="text-sm text-yellow-800">
                                    ‚ö†Ô∏è Admin permission required to modify automation settings. / Ëá™ÂãïÂåñË®≠ÂÆö„ÅÆÂ§âÊõ¥„Å´„ÅØAdminÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                                </p>
                            </div>
                        </div>

                        <div v-if="checkerResults.nmos">
                            <p class="text-xs text-slate-500">
                                Last executed: {{ checkerResults.nmos.fetchedAt }} /
                                Checked: {{ checkerResults.nmos.checked }} /
                                Skipped: {{ checkerResults.nmos.skipped }} /
                                With differences: {{ checkerResults.nmos.differences.length }}
                            </p>
                            <div class="border rounded p-4" v-if="checkerResults.nmos.differences.length > 0">
                                <h3 class="font-semibold text-base mb-2">Flows with differences</h3>
                                <div class="overflow-auto">
                                    <table class="w-full text-xs border border-slate-200">
                                        <thead class="bg-slate-100 text-slate-600">
                                            <tr>
                                                <th class="px-3 py-2 text-left">Flow</th>
                                                <th class="px-3 py-2 text-left">Node</th>
                                                <th class="px-3 py-2 text-left">Difference Count</th>
                                                <th class="px-3 py-2 text-left">Fields</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="entry in checkerResults.nmos.differences" :key="entry.flow_id" class="border-t">
                                                <td class="px-3 py-2">
                                                    <div class="font-semibold text-sm">{{ entry.display_name || entry.flow_id }}</div>
                                                    <div class="font-mono text-[11px] break-all flex items-center gap-2">
                                                        <span>{{ entry.flow_id }}</span>
                                                        <button
                                                            class="text-[10px] px-2 py-0.5 border rounded text-slate-600 hover:bg-slate-100"
                                                            @click="copyToClipboard(entry.flow_id)"
                                                        >
                                                            Copy
                                                        </button>
                                                    </div>
                                                    <div class="flex gap-2 mt-1">
                                                        <button
                                                            class="text-[11px] text-emerald-600 underline"
                                                            @click="showFlow(entry.flow_id)"
                                                        >
                                                            Details
                                                        </button>
                                                        <button
                                                            class="text-[11px] text-slate-600 underline"
                                                            @click="loadFlowForEdit(entry.flow_id)"
                                                        >
                                                            Edit
                                                        </button>
                                                    </div>
                                                </td>
                                                <td class="px-3 py-2 text-xs text-slate-600">{{ entry.nmos_node_label || '-' }}</td>
                                                <td class="px-3 py-2">{{ entry.difference_count }}</td>
                                                <td class="px-3 py-2">
                                                    <ul class="list-disc list-inside text-[11px] text-slate-600">
                                                        <li v-for="field in entry.fields" :key="field">{{ field }}</li>
                                                    </ul>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="border rounded p-4" v-if="checkerResults.nmos.errors.length > 0">
                                <h3 class="font-semibold text-base mb-2">Errors</h3>
                                <ul class="space-y-2 text-xs text-red-600">
                                    <li v-for="err in checkerResults.nmos.errors" :key="err.flow_id">
                                        <span class="font-semibold">{{ err.display_name || err.flow_id }}:</span>
                                        <span>{{ err.reason }}</span>
                                    </li>
                                </ul>
                            </div>
                            <p v-if="checkerResults.nmos.differences.length === 0 && checkerResults.nmos.errors.length === 0" class="text-xs text-emerald-600">
                                All checked flows match their NMOS data.
                            </p>
                        </div>
                        <p v-else class="text-xs text-slate-500">No NMOS check has been executed yet.</p>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='users'">
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-lg">Users / „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</h2>
                        <button class="px-3 py-1 bg-slate-900 text-white rounded text-sm" @click="fetchUsers">Reload</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <label class="text-xs text-slate-500">Username
                            <input class="w-full border rounded px-3 py-2" v-model="newUser.username" />
                        </label>
                        <label class="text-xs text-slate-500">Password
                            <input type="password" class="w-full border rounded px-3 py-2" v-model="newUser.password" />
                        </label>
                        <label class="text-xs text-slate-500">Role
                            <select class="w-full border rounded px-3 py-2" v-model="newUser.role">
                                <option value="viewer">viewer</option>
                                <option value="editor">editor</option>
                                <option value="admin">admin</option>
                            </select>
                        </label>
                    </div>
                    <p class="text-[11px] text-slate-500">
                        Username must be 3-64 chars, password 4-128 chars (per API validation).
                    </p>
                    <button class="px-4 py-2 bg-emerald-600 text-white rounded text-sm" @click="createUser">Add User</button>
                    <div class="overflow-auto">
                        <table class="w-full text-sm border border-slate-200">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="px-3 py-2 text-left">Username</th>
                                    <th class="px-3 py-2 text-left">Role</th>
                                    <th class="px-3 py-2 text-left">Created At</th>
                                    <th class="px-3 py-2 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="user in users" :key="user.username" class="border-t">
                                    <td class="px-3 py-2 font-semibold">{{ user.username }}</td>
                                    <td class="px-3 py-2">
                                        <select class="border rounded px-2 py-1 text-xs" v-model="user.role" @change="updateUserInfo(user)">
                                            <option value="viewer">viewer</option>
                                            <option value="editor">editor</option>
                                            <option value="admin">admin</option>
                                        </select>
                                    </td>
                                    <td class="px-3 py-2 text-xs">{{ user.created_at }}</td>
                                    <td class="px-3 py-2 text-xs text-center">
                                        <button class="text-emerald-600 underline mr-3" @click="updateUserInfo(user)">Save</button>
                                        <button class="text-red-500 underline" @click="deleteUser(user.username)">Delete</button>
                                    </td>
                                </tr>
                                <tr v-if="users.length === 0">
                                    <td colspan="4" class="text-center py-4 text-slate-500">No users found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='settings'">
                <div class="space-y-4">
                    <section class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="font-semibold text-lg">Connection Settings</h2>
                            <button class="px-3 py-1 bg-slate-900 text-white rounded text-sm" @click="loadBaseUrl">Reload</button>
                        </div>
                        <label class="text-sm text-slate-500">API Base URL
                            <input type="text" v-model="baseUrl" class="w-full border rounded px-3 py-2 mt-1 bg-white text-slate-700 text-sm" placeholder="http://localhost:8080" />
                        </label>
                        <div class="flex gap-2">
                            <button class="px-3 py-2 bg-slate-900 text-white rounded text-sm" @click="saveBaseUrl">Save</button>
                            <button class="px-3 py-2 border rounded text-sm" @click="loadBaseUrl">Reset</button>
                        </div>
                        <p class="text-xs text-slate-500">Stored in browser local storage.</p>
                        <div class="border-t pt-4 space-y-2">
                            <h3 class="font-semibold text-base">MQTT WebSocket</h3>
                            <p class="text-xs text-slate-500">Override the MQTT WS URL for this browser. Leave blank to use the server configuration.</p>
                            <input type="text" class="w-full border rounded px-3 py-2 bg-white text-slate-700 text-sm" v-model="realtime.wsUrlInput" placeholder="ws://host:9001" />
                            <div class="flex gap-2">
                                <button class="px-3 py-2 bg-slate-900 text-white rounded text-sm" @click="saveMqttOverride">Save</button>
                                <button class="px-3 py-2 border rounded text-sm" @click="resetMqttOverride">Reset</button>
                            </div>
                        </div>
                        <div class="border-t pt-4 space-y-2">
                            <h3 class="font-semibold text-base">Login</h3>
                            <p class="text-xs text-slate-500">Current: {{ currentUser ? currentUser.username : "Not signed in" }}</p>
                            <div v-if="!token" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <input type="text" v-model="loginForm.username" placeholder="username" class="border rounded px-3 py-2" />
                                <input type="password" v-model="loginForm.password" placeholder="password" class="border rounded px-3 py-2" />
                                <button class="bg-emerald-600 text-white rounded px-3 py-2" @click="login">Log in</button>
                            </div>
                            <div v-else class="text-xs text-slate-500">Already logged in. Log out to re-authenticate.</div>
                        </div>
                    </section>

                    <section class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="font-semibold text-lg">Application Settings</h2>
                            <button class="px-3 py-1 bg-slate-900 text-white rounded text-sm" @click="fetchSettings">Reload</button>
                        </div>
                        <div class="space-y-2">
                            <template v-for="(value, key) in settings" :key="key">
                                <div
                                    v-if="key !== 'flow_lock_role'"
                                    class="border rounded p-3 flex items-center justify-between"
                                >
                                    <div>
                                        <p class="text-sm font-semibold">{{ key }}</p>
                                        <p class="text-xs text-slate-500">Current value: {{ value }}</p>
                                    </div>
                                    <button class="px-3 py-1 border rounded text-sm" @click="updateSetting(key, value === true ? false : true)" v-if="typeof value === 'boolean'">
                                        {{ value ? 'Disable' : 'Enable' }}
                                    </button>
                                    <button class="px-3 py-1 border rounded text-sm" v-else disabled>Read only</button>
                                </div>
                            </template>
                            <div class="border rounded p-3 space-y-2">
                                <div>
                                    <p class="text-sm font-semibold">Flow Lock Role</p>
                                    <p class="text-xs text-slate-500">Select who can toggle flow locks.</p>
                                </div>
                                <label class="flex items-center gap-2 text-sm text-slate-600">
                                    <input
                                        type="radio"
                                        value="admin"
                                        v-model="settings.flow_lock_role"
                                        @change="updateSetting('flow_lock_role', settings.flow_lock_role)"
                                    />
                                    Admin only
                                </label>
                                <label class="flex items-center gap-2 text-sm text-slate-600">
                                    <input
                                        type="radio"
                                        value="editor"
                                        v-model="settings.flow_lock_role"
                                        @change="updateSetting('flow_lock_role', settings.flow_lock_role)"
                                    />
                                    Editor or higher
                                </label>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="font-semibold text-lg">System Logs</h2>
                            <button class="px-3 py-1 bg-slate-900 text-white rounded text-sm" @click="refreshAllLogs" :disabled="logViewer.loading">
                                {{ logViewer.loading ? 'Loading...' : 'Refresh all' }}
                            </button>
                        </div>
                        <p class="text-xs text-slate-500">View or download recent API / audit logs (admin only).</p>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="border rounded-lg p-3 space-y-2">
                                <div class="flex items-center justify-between text-sm">
                                    <h3 class="font-semibold">API Log</h3>
                                    <div class="flex gap-2">
                                        <button class="px-2 py-1 border rounded text-xs" @click="refreshLogPreview('api')" :disabled="logViewer.loading">Refresh</button>
                                        <button class="px-2 py-1 border rounded text-xs" @click="downloadLog('api')">Download</button>
                                    </div>
                                </div>
                                <pre class="bg-slate-900 text-slate-100 text-[11px] rounded p-2 max-h-48 overflow-auto whitespace-pre-wrap">{{ logViewer.api.length ? logViewer.api.join('\n') : 'No log data' }}</pre>
                            </div>
                            <div class="border rounded-lg p-3 space-y-2">
                                <div class="flex items-center justify-between text-sm">
                                    <h3 class="font-semibold">Audit Log</h3>
                                    <div class="flex gap-2">
                                        <button class="px-2 py-1 border rounded text-xs" @click="refreshLogPreview('audit')" :disabled="logViewer.loading">Refresh</button>
                                        <button class="px-2 py-1 border rounded text-xs" @click="downloadLog('audit')">Download</button>
                                    </div>
                                </div>
                                <pre class="bg-slate-900 text-slate-100 text-[11px] rounded p-2 max-h-48 overflow-auto whitespace-pre-wrap">{{ logViewer.audit.length ? logViewer.audit.join('\n') : 'No log data' }}</pre>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white rounded shadow-lg p-4 space-y-3 border border-red-100">
                        <h2 class="font-semibold text-lg text-red-600">Hard Delete Flow</h2>
                        <p class="text-xs text-red-500">
                            Completely deletes the record with the specified flow_id from the database. Calls the
                            /api/flows/&lt;flow_id&gt;/hard endpoint. Cannot be restored.
                        </p>
                        <div class="flex flex-col md:flex-row gap-3">
                            <input
                                type="text"
                                class="flex-1 border rounded px-3 py-2 text-sm font-mono"
                                placeholder="UUID flow_id"
                                v-model="hardDeleteFlowId"
                            />
                            <button
                                class="px-4 py-2 bg-red-600 text-white rounded text-sm disabled:opacity-50"
                                :disabled="!hardDeleteFlowId"
                                @click="hardDeleteFlow"
                            >
                                Permanently Delete
                            </button>
                        </div>
                    </section>

                    <section class="bg-white rounded shadow-lg p-4 space-y-3">
                        <h2 class="font-semibold text-lg">Flow Data Import / Export</h2>
                        <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
                            <button
                                class="px-4 py-2 bg-slate-900 text-white rounded text-sm disabled:opacity-50"
                                @click="exportFlows"
                                :disabled="!token"
                            >
                                Download JSON
                            </button>
                            <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
                                <span class="px-3 py-2 border rounded bg-white">Choose JSON</span>
                                <input
                                    type="file"
                                    accept="application/json"
                                    class="hidden"
                                    @change="handleImportFile"
                                    ref="flowImportInput"
                                />
                                <span class="text-xs text-slate-500">
                                    {{ importFile ? importFile.name : 'No file selected' }}
                                </span>
                            </label>
                            <button
                                class="px-4 py-2 bg-emerald-600 text-white rounded text-sm disabled:opacity-50"
                                :disabled="!importFile || importingFlows"
                                @click="importFlows"
                            >
                                {{ importingFlows ? 'Uploading...' : 'Import JSON' }}
                            </button>
                        </div>
                        <p class="text-xs text-slate-500">
                            Admin only. Locked flows are skipped during import.
                        </p>
                    </section>
                </div>
            </template>

            <template v-else>
                <section class="bg-white rounded shadow-lg p-6 text-sm text-slate-500">
                    This section is not implemented yet.
                </section>
            </template>

            <!-- RDS Nodes Modal -->
            <div
                v-if="wizard.rdsNodesModal.visible"
                class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
                @click="wizard.rdsNodesModal.visible = false"
            >
                <div class="bg-white rounded shadow-lg w-full max-w-2xl max-h-[70vh] overflow-auto" @click.stop>
                    <div class="flex justify-between items-center px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold">Select NMOS Node from RDS</h3>
                        <button class="text-sm text-slate-500" @click="wizard.rdsNodesModal.visible = false">Close</button>
                    </div>
                    <div class="p-6">
                        <p v-if="wizard.rdsNodesModal.nodes.length === 0" class="text-sm text-slate-500 text-center py-8">
                            No nodes found in RDS.
                        </p>
                        <div v-else class="space-y-3">
                            <label
                                v-for="(node, index) in wizard.rdsNodesModal.nodes"
                                :key="index"
                                class="flex items-start gap-3 p-3 border rounded cursor-pointer hover:bg-slate-50"
                                :class="{ 'border-blue-500 bg-blue-50': wizard.rdsNodesModal.selected === index }"
                            >
                                <input
                                    type="radio"
                                    :value="index"
                                    v-model="wizard.rdsNodesModal.selected"
                                    class="mt-1"
                                />
                                <div class="flex-1">
                                    <p class="font-semibold text-sm">{{ node.label }}</p>
                                    <p class="text-xs text-slate-500">Node ID: {{ node.id }}</p>
                                    <p class="text-xs text-blue-600 font-mono mt-1">{{ node.is04_url }}</p>
                                    <p class="text-[11px] text-slate-400">Version: {{ node.version }}</p>
                                </div>
                            </label>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button
                                class="px-4 py-2 border rounded text-sm"
                                @click="wizard.rdsNodesModal.visible = false"
                            >
                                Cancel
                            </button>
                            <button
                                class="px-4 py-2 rounded bg-blue-600 text-white text-sm disabled:opacity-50"
                                :disabled="wizard.rdsNodesModal.selected === null"
                                @click="applyRDSNode"
                            >
                                Use Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IS-05 Detection Modal -->
            <div
                v-if="wizard.is05DetectionModal.visible"
                class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
                @click="wizard.is05DetectionModal.visible = false"
            >
                <div class="bg-white rounded shadow-lg w-full max-w-2xl max-h-[70vh] overflow-auto" @click.stop>
                    <div class="flex justify-between items-center px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold">Select IS-05 Connection API</h3>
                        <button class="text-sm text-slate-500" @click="wizard.is05DetectionModal.visible = false">Close</button>
                    </div>
                    <div class="p-6">
                        <p v-if="wizard.is05DetectionModal.options.length === 0" class="text-sm text-slate-500 text-center py-8">
                            No IS-05 endpoints found in devices.
                        </p>
                        <div v-else class="space-y-3">
                            <label
                                v-for="(option, index) in wizard.is05DetectionModal.options"
                                :key="index"
                                class="flex items-start gap-3 p-3 border rounded cursor-pointer hover:bg-slate-50"
                                :class="wizard.is05DetectionModal.selected === index && 'border-emerald-500 bg-emerald-50'"
                            >
                                <input
                                    type="radio"
                                    :value="index"
                                    v-model="wizard.is05DetectionModal.selected"
                                    class="mt-1"
                                />
                                <div class="flex-1">
                                    <p class="font-semibold text-sm">{{ option.device_label }}</p>
                                    <p class="text-xs text-slate-500">Device ID: {{ option.device_id }}</p>
                                    <p class="text-xs text-emerald-600 font-mono mt-1">{{ option.is05_url }}</p>
                                    <p class="text-[11px] text-slate-400">Version: {{ option.version }}</p>
                                </div>
                            </label>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button
                                class="px-4 py-2 border rounded text-sm"
                                @click="wizard.is05DetectionModal.visible = false"
                            >
                                Cancel
                            </button>
                            <button
                                class="px-4 py-2 rounded bg-emerald-600 text-white text-sm disabled:opacity-50"
                                :disabled="wizard.is05DetectionModal.selected === null"
                                @click="applyDetectedIS05"
                            >
                                Use Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div
                v-if="nmos.applyVisible && nmos.result"
                class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
                @click="closeNmosApplyDialog"
            >
                <div class="bg-white rounded shadow-lg w-full max-w-2xl max-h-[80vh] overflow-auto" @click.stop>
                    <div class="flex justify-between items-center px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold">NMOS Sync / NMOSÂèçÊò†</h3>
                        <button class="text-sm text-slate-500" @click="closeNmosApplyDialog">Close</button>
                    </div>
                    <div class="p-6 space-y-3 text-sm">
                        <p>Flow: <span class="font-mono">{{ nmos.result.flow_id }}</span></p>
                        <p class="text-xs text-slate-500">Select the fields to overwrite with the latest NMOS values.</p>
                        <div class="max-h-64 overflow-auto border rounded divide-y">
                            <label
                                v-for="field in (nmos.result.comparable_fields || [])"
                                :key="field"
                                class="flex items-start gap-3 px-4 py-2 text-xs text-slate-600"
                            >
                                <input type="checkbox" class="mt-1" :value="field" v-model="nmos.applySelections" />
                                <div class="flex-1">
                                    <p class="font-semibold">{{ field }}</p>
                                    <p class="text-[11px] text-slate-500">
                                        Current: {{ nmosDiffValue(field)?.current ?? '‚Äî' }}
                                    </p>
                                    <p class="text-[11px] text-emerald-600">
                                        NMOS: {{ nmosDiffValue(field)?.nmos ?? nmos.result.snapshot[field] ?? '‚Äî' }}
                                    </p>
                                </div>
                            </label>
                        </div>
                        <div class="flex justify-between items-center text-xs text-slate-500">
                            <span>Selected: {{ nmos.applySelections.length }}</span>
                            <div class="flex gap-2">
                                <button class="px-3 py-1 border rounded" @click="closeNmosApplyDialog">Cancel</button>
                                <button
                                    class="px-4 py-1 rounded bg-emerald-600 text-white disabled:opacity-50"
                                    :disabled="nmos.applying || nmos.applySelections.length === 0"
                                    @click="applyNmos(nmos.result.flow_id)"
                                >
                                    {{ nmos.applying ? 'Applying...' : 'Apply & Update' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="detailFlow" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40" @click="detailFlow = null">
                <div class="bg-white rounded shadow-lg w-full max-w-4xl max-h-[80vh] overflow-auto" @click.stop>
                    <div class="flex justify-between items-center px-6 py-4 border-b">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="text-lg font-semibold" v-text="detailFlow ? (detailFlow.display_name || detailFlow.flow_id) : ''"></h3>
                                <span v-if="detailFlow?.locked" class="text-slate-500 text-base leading-none">‚öø</span>
                            </div>
                            <p class="text-xs text-slate-500 flex items-center gap-2">
                                flow_id:
                                <span class="font-mono" v-text="detailFlow ? detailFlow.flow_id : ''"></span>
                                <button
                                    class="text-[11px] px-2 py-1 border rounded text-slate-600 hover:bg-slate-100"
                                    @click="copyToClipboard(detailFlow?.flow_id)"
                                >
                                    Copy
                                </button>
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                class="px-3 py-1 text-xs border rounded"
                                :disabled="nmos.checking"
                                @click="checkNmos(detailFlow.flow_id)"
                            >
                                NMOS Check
                            </button>
                            <button class="px-3 py-1 text-xs border rounded bg-slate-100 text-slate-400 cursor-not-allowed" disabled>
                                NMOS Sync
                            </button>
                            <button class="text-sm text-slate-500" @click="closeDetail">Close</button>
                        </div>
                    </div>
                    <p v-if="nmos.error && nmos.targetFlowId === detailFlow?.flow_id" class="px-6 pt-3 text-xs text-red-600">
                        {{ nmos.error }}
                    </p>
                    <div class="p-6 space-y-4">
                        <!-- Grouped Display (Same style as Edit screen) -->
                        <div v-for="group in detailEntries" :key="group.title" class="border rounded p-4">
                            <h3 class="font-semibold text-base mb-3">{{ group.title }}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div
                                    v-for="field in group.fields"
                                    :key="field.key"
                                    class="text-xs text-slate-500 space-y-1"
                                >
                                    <div class="flex items-center justify-between">
                                        <label>{{ field.label }}</label>
                                        <button
                                            class="text-[10px] px-2 py-0.5 border rounded text-slate-600 hover:bg-slate-100"
                                            @click="copyToClipboard(field.value)"
                                        >
                                            Copy
                                        </button>
                                    </div>
                                    <div
                                        :class="['w-full border rounded px-3 py-2 bg-slate-50 font-mono text-xs break-words whitespace-pre-wrap', isNmosDiff(field.key, detailFlow.flow_id) ? 'border-red-500 ring-1 ring-red-400 bg-red-50' : '']"
                                    >{{ field.value }}</div>
                                    <p
                                        v-if="isNmosDiff(field.key, detailFlow.flow_id)"
                                        class="text-[11px] text-red-600 font-mono"
                                    >
                                        NMOS: {{ nmosDiffValue(field.key)?.nmos ?? '' }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <p v-if="detailEntries.length === 0" class="text-center text-sm text-slate-500 py-8">No data.</p>
                    </div>
                </div>
            </div>
        </main>
        </div>
    </div>
    <script src="vendor/vue.global.prod.js"></script>
    <script src="vendor/mqtt.min.js"></script>
    <script src="./main.js"></script>
    <style>
        .toast-fade-enter-active,
        .toast-fade-leave-active {
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .toast-fade-enter-from,
        .toast-fade-leave-to {
            opacity: 0;
            transform: translateY(-20px);
        }
        @keyframes folderPulse {
            0% { box-shadow: 0 0 0 0 rgba(37,99,235,0.25); }
            50% { box-shadow: 0 0 0 4px rgba(37,99,235,0.08); }
            100% { box-shadow: 0 0 0 0 rgba(37,99,235,0); }
        }
        .folder-hint-border {
            animation: folderPulse 2.2s ease-in-out infinite;
        }
        @keyframes buttonGlowBlink {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.1); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .auto-detect-blink {
            animation: buttonGlowBlink 2.5s ease-in-out infinite;
        }
    </style>
</body>
</html>
